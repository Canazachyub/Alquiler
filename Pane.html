<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Alquiler</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
        }
        
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 250px;
            height: 100vh;
            background: #2c3e50;
            color: white;
            padding: 20px 0;
        }
        
        .sidebar h3 {
            text-align: center;
            padding: 0 20px 20px;
            border-bottom: 1px solid #34495e;
        }
        
        .sidebar ul {
            list-style: none;
            padding: 20px 0;
        }
        
        .sidebar li {
            padding: 15px 20px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .sidebar li:hover,
        .sidebar li.active {
            background: #34495e;
        }
        
        .content {
            margin-left: 250px;
            padding: 20px;
        }
        
        .header {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .tab-content {
            display: none;
            background: white;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .tab-content.active {
            display: block;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-card h4 {
            color: #7f8c8d;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
            margin-right: 10px;
        }
        
        .button:hover {
            background: #2980b9;
        }
        
        .button-success {
            background: #27ae60;
        }
        
        .button-success:hover {
            background: #229954;
        }
        
        .button-danger {
            background: #e74c3c;
        }
        
        .button-danger:hover {
            background: #c0392b;
        }
        
        .button-small {
            padding: 5px 15px;
            font-size: 14px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background: #f8f9fa;
            font-weight: bold;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .room-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .room-card {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .room-card:hover {
            border-color: #3498db;
            transform: translateY(-2px);
        }
        
        .room-card.occupied {
            background: #ecf0f1;
        }
        
        .room-card.vacant {
            background: #e8f6f3;
            border-color: #27ae60;
        }
        
        .status-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-left: 5px;
        }
        
        .status-paid {
            background: #27ae60;
        }
        
        .status-pending {
            background: #e74c3c;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: #27ae60;
            color: white;
            border-radius: 5px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 10000;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: #e74c3c;
        }

        .notification.warning {
            background: #f39c12;
        }

        .stats-advanced {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .stat-card.warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
        }

        .stat-card.danger {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
        }

        .incidents-table {
            width: 100%;
            margin-top: 20px;
        }

        .priority-high {
            color: #e74c3c;
            font-weight: bold;
        }

        .priority-medium {
            color: #f39c12;
        }

        .priority-low {
            color: #27ae60;
        }

        .status-resolved {
            color: #27ae60;
        }

        #notificationBadge {
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            padding: 2px 8px;
            font-size: 12px;
            position: absolute;
            top: -8px;
            right: -8px;
        }

        .search-container {
            margin-bottom: 20px;
        }

        .search-container input {
            width: 300px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .export-button {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
        }

        .export-button:hover {
            background: #2980b9;
        }

        .backup-button {
            background: #9b59b6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }

        .backup-button:hover {
            background: #8e44ad;
        }

        .filter-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }

        .filter-controls select,
        .filter-controls input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        #incidentsList {
            width: 100%;
            overflow-x: auto;
        }

        #reportsContent {
            width: 100%;
            min-height: 200px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin-top: 20px;
        }

        .vouchers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .voucher-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .voucher-card h4 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .voucher-card p {
            margin: 5px 0;
            color: #7f8c8d;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .content {
                margin-left: 0;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
        /* Estilos para navegaci√≥n de pagos */
        #paymentMonthSummary {
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #currentViewingMonth {
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        #paymentsTable tbody tr {
            transition: background-color 0.2s;
        }

        #paymentsTable tbody tr:hover {
            background-color: #f8f9fa;
        }

        .payment-month-nav {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .payment-summary-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Estilos adicionales para gastos y dashboard mejorado */
        .stat-change, .stat-percentage, .stat-comparison, .stat-indicator {
            font-size: 12px;
            margin-top: 5px;
            font-weight: normal;
        }

        .category-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
        }

        #dashboardChart {
            max-width: 100%;
            height: auto;
        }

        .dashboard-alert {
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
            border-left: 4px solid;
        }

        .dashboard-alert.warning {
            background: #fff3cd;
            border-color: #ffc107;
        }

        .dashboard-alert.danger {
            background: #f8d7da;
            border-color: #dc3545;
        }

        #expenseMonthSummary > div > div {
            text-align: center;
            padding: 10px;
            border-radius: 5px;
            background: #f8f9fa;
        }

        #recentPaymentsList ul li:hover,
        #upcomingDuesList ul li:hover {
            background: #f8f9fa;
        }
        /* Estilos mejorados para habitaciones */
        .room-card {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            background: white;
        }

        .room-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .room-card.room-debt {
            border-color: #e74c3c;
            background: linear-gradient(135deg, #fff 0%, #fee 100%);
        }

        .room-card.room-paid {
            border-color: #27ae60;
            background: linear-gradient(135deg, #fff 0%, #efffef 100%);
        }

        .room-card.vacant {
            border-color: #95a5a6;
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
        }

        .status-paid {
            color: #27ae60;
        }

        .status-pending {
            color: #e74c3c;
        }
    </style>
</head>
<body>
    <div id="loading">
        <div class="loading-spinner"></div>
    </div>
    
    <!-- SIDEBAR -->
    <div class="sidebar">
        <h3>Sistema de Alquiler</h3>
        <ul>
            <li class="active" onclick="showTab('dashboard', event)">Dashboard</li>
            <li onclick="showTab('rooms', event)">Habitaciones</li>
            <li onclick="showTab('tenants', event)">Inquilinos</li>
            <li onclick="showTab('payments', event)">Pagos</li>
            <li onclick="showTab('expenses', event)">Gastos</li>
            <li onclick="showTab('incidents', event)">Incidencias</li>
            <li onclick="showTab('reports', event)">Reportes</li>
            <li onclick="showTab('vouchers', event)">Vouchers</li>
            <li onclick="createBackup()" class="backup-button">Backup</li>
        </ul>
    </div>
    
    <!-- CONTENIDO PRINCIPAL -->
    <div class="content">

    <!-- CABECERA -->
    <div class="header">
        <h1>Panel de Administraci√≥n</h1>
        <div style="display:flex;align-items:center;gap:20px;">
            <div style="position:relative; cursor: pointer;" onclick="showNotificationsModal()">
                <span style="padding: 8px 15px; background: #3498db; color: white; border-radius: 20px; display: inline-flex; align-items: center; gap: 8px;">
                    üîî Notificaciones
                    <span id="notificationBadge" style="display:none; background: #e74c3c; color: white; border-radius: 50%; padding: 2px 8px; font-size: 12px; position: static; margin-left: 5px;"></span>
                </span>
            </div>

            <select id="monthSelect" onchange="updateMonth()">
                <option value="1">Enero</option>
                <option value="2">Febrero</option>
                <option value="3">Marzo</option>
                <option value="4">Abril</option>
                <option value="5">Mayo</option>
                <option value="6">Junio</option>
                <option value="7">Julio</option>
                <option value="8">Agosto</option>
                <option value="9">Septiembre</option>
                <option value="10">Octubre</option>
                <option value="11">Noviembre</option>
                <option value="12">Diciembre</option>
            </select>
            
            <select id="yearSelect" onchange="updateMonth()" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <!-- Se llenar√° din√°micamente -->
            </select>
        </div>
    </div>

        <!-- DASHBOARD -->
        <div id="dashboard" class="tab-content active">
            <h2>Dashboard - Panel de Control</h2>
            
            <!-- Botones de acci√≥n r√°pida -->
            <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="button button-danger" onclick="resetMonthlyPaymentsConfirm()">Resetear Pagos del Mes</button>
                <button class="button" onclick="showQuickPaymentModal()">Pago R√°pido</button>
                <button class="button" onclick="generateMonthlyReport()">Generar Informe</button>
                <button class="button button-success" onclick="refreshDashboard()">Actualizar Datos</button>
            </div>
            
            <!-- Estad√≠sticas principales -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h4>Total Habitaciones</h4>
                    <div id="totalRooms" class="value">0</div>
                    <div class="stat-change" id="roomsChange"></div>
                </div>
                <div class="stat-card">
                    <h4>Habitaciones Ocupadas</h4>
                    <div id="occupiedRooms" class="value">0</div>
                    <div class="stat-percentage" id="occupancyPercentage"></div>
                </div>
                <div class="stat-card">
                    <h4>Tasa de Ocupaci√≥n</h4>
                    <div id="occupancyRate" class="value">0%</div>
                    <div class="stat-indicator" id="occupancyIndicator"></div>
                </div>
                <div class="stat-card">
                    <h4>Ingresos del Mes</h4>
                    <div id="monthlyIncome" class="value">S/ 0</div>
                    <div class="stat-comparison" id="incomeComparison"></div>
                </div>
                <div class="stat-card">
                    <h4>Gastos del Mes</h4>
                    <div id="monthlyExpenses" class="value">S/ 0</div>
                    <div class="stat-comparison" id="expenseComparison"></div>
                </div>
                <div class="stat-card">
                    <h4>Balance</h4>
                    <div id="balance" class="value">S/ 0</div>
                    <div class="stat-indicator" id="balanceIndicator"></div>
                </div>
            </div>

            <!-- Panel de actividad reciente -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                
                <!-- √öltimos pagos -->
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                    <h3 style="margin-bottom: 15px; color: #2c3e50;">√öltimos Pagos Registrados</h3>
                    <div id="recentPaymentsList" style="max-height: 300px; overflow-y: auto;">
                        <!-- Se llenar√° din√°micamente -->
                    </div>
                </div>
                
                <!-- Pr√≥ximos vencimientos -->
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                    <h3 style="margin-bottom: 15px; color: #2c3e50;">Pr√≥ximos Vencimientos</h3>
                    <div id="upcomingDuesList" style="max-height: 300px; overflow-y: auto;">
                        <!-- Se llenar√° din√°micamente -->
                    </div>
                </div>
            </div>

            <!-- Gr√°fico de tendencias -->
            <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-top: 20px;">
                <h3 style="margin-bottom: 15px; color: #2c3e50;">Tendencia de Ingresos vs Gastos (√öltimos 6 meses)</h3>
                <div id="trendChart" style="height: 300px;">
                    <!-- Gr√°fico simple con barras -->
                    <canvas id="dashboardChart" width="400" height="200"></canvas>
                </div>
            </div>

            <!-- Estad√≠sticas avanzadas -->
            <div id="advancedStats"></div>
            
            <!-- Alertas y notificaciones -->
            <div id="dashboardAlerts" style="margin-top: 20px;">
                <!-- Se llenar√° din√°micamente con alertas importantes -->
            </div>
        </div>

        <!-- HABITACIONES -->
        <div id="rooms" class="tab-content">
            <h2>Gesti√≥n de Habitaciones</h2>
            
            <!-- Panel de resumen de cobros -->
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px;">Resumen de Cobros del Mes</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 5px;">
                        <div style="font-size: 12px; opacity: 0.9;">Total por Cobrar</div>
                        <div id="totalPorCobrar" style="font-size: 28px; font-weight: bold;">S/ 0.00</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 5px;">
                        <div style="font-size: 12px; opacity: 0.9;">Habitaciones que Deben</div>
                        <div id="habitacionesDeudoras" style="font-size: 28px; font-weight: bold;">0</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 5px;">
                        <div style="font-size: 12px; opacity: 0.9;">Habitaciones al D√≠a</div>
                        <div id="habitacionesAlDia" style="font-size: 28px; font-weight: bold;">0</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 5px;">
                        <div style="font-size: 12px; opacity: 0.9;">Fecha de Vencimiento</div>
                        <div id="fechaVencimiento" style="font-size: 20px; font-weight: bold;">D√≠a 5</div>
                    </div>
                </div>
            </div>
            
            <!-- Filtros de habitaciones -->
            <div style="background: white; padding: 15px; border-radius: 5px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <button class="button button-small" onclick="filterRooms('all')" id="filterAll">Todas</button>
                    <button class="button button-small" onclick="filterRooms('debt')" id="filterDebt" style="background: #e74c3c;">Con Deuda</button>
                    <button class="button button-small" onclick="filterRooms('paid')" id="filterPaid" style="background: #27ae60;">Al D√≠a</button>
                    <button class="button button-small" onclick="filterRooms('vacant')" id="filterVacant" style="background: #95a5a6;">Vac√≠as</button>
                    
                    <div style="margin-left: auto;">
                        <button class="button" onclick="sendPaymentReminders()">Enviar Recordatorios</button>
                        <button class="button button-success" onclick="markAllAsPaid()">Marcar Todos Pagados</button>
                    </div>
                </div>
                
                <!-- Barra de b√∫squeda -->
                <div style="margin-top: 15px;">
                    <input type="text" id="roomSearchInput" placeholder="Buscar habitaci√≥n o inquilino..." 
                          style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"
                          onkeyup="searchRooms()">
                </div>
            </div>
            
            <!-- Grid de habitaciones mejorado -->
            <div id="roomsGrid" class="room-grid"></div>
            
            <!-- Detalle de deudas -->
            <div id="debtDetails" style="display: none; margin-top: 20px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                <h3>Detalle de Habitaciones con Deuda</h3>
                <table style="width: 100%; margin-top: 15px;">
                    <thead>
                        <tr style="background: #f8f9fa;">
                            <th style="padding: 10px;">Habitaci√≥n</th>
                            <th style="padding: 10px;">Inquilino</th>
                            <th style="padding: 10px;">Tel√©fono</th>
                            <th style="padding: 10px;">Alquiler</th>
                            <th style="padding: 10px;">Internet</th>
                            <th style="padding: 10px;">Total Deuda</th>
                            <th style="padding: 10px;">D√≠as Vencido</th>
                            <th style="padding: 10px;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="debtDetailsBody"></tbody>
                </table>
            </div>
        </div>

        <!-- INQUILINOS -->
        <div id="tenants" class="tab-content">
            <h2>Gesti√≥n de Inquilinos</h2>
            <div class="search-container">
                <input id="searchInput" type="text" placeholder="Buscar inquilino..." />
            </div>
            <button class="button" onclick="showNewTenantModal()">Nuevo Inquilino</button>
            
            <table id="tenantsTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Habitaci√≥n</th>
                        <th>Tel√©fono</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- PAGOS -->
        <div id="payments" class="tab-content">
            <h2>Registro de Pagos</h2>
            
            <!-- NUEVA BARRA DE NAVEGACI√ìN DE MESES -->
            <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px;">
                    
                    <!-- Controles de navegaci√≥n -->
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <button class="button button-small" onclick="navigatePaymentMonth(-1)">‚óÑ Mes Anterior</button>
                        
                        <select id="paymentMonthSelect" onchange="loadPaymentsBySelectedMonth()" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="1">Enero</option>
                            <option value="2">Febrero</option>
                            <option value="3">Marzo</option>
                            <option value="4">Abril</option>
                            <option value="5">Mayo</option>
                            <option value="6">Junio</option>
                            <option value="7">Julio</option>
                            <option value="8">Agosto</option>
                            <option value="9">Septiembre</option>
                            <option value="10">Octubre</option>
                            <option value="11">Noviembre</option>
                            <option value="12">Diciembre</option>
                        </select>
                        
                        <select id="paymentYearSelect" onchange="loadPaymentsBySelectedMonth()" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <!-- Se llenar√° din√°micamente -->
                        </select>
                        
                        <button class="button button-small" onclick="navigatePaymentMonth(1)">Mes Siguiente ‚ñ∫</button>
                    </div>
                    
                    <!-- Bot√≥n de nuevo pago -->
                    <div>
                        <button class="button" onclick="showNewPaymentModal()">Registrar Pago</button>
                        <button class="button button-success" onclick="goToCurrentMonth()">Mes Actual</button>
                    </div>
                </div>
                
                <!-- Resumen del mes seleccionado -->
                <div id="paymentMonthSummary" style="margin-top: 15px; padding: 10px; background: white; border-radius: 4px; display: none;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                        <div>
                            <span style="color: #7f8c8d; font-size: 12px;">Total Recaudado</span>
                            <div id="monthTotalCollected" style="font-size: 20px; font-weight: bold; color: #27ae60;">S/ 0.00</div>
                        </div>
                        <div>
                            <span style="color: #7f8c8d; font-size: 12px;">Pagos Registrados</span>
                            <div id="monthPaymentCount" style="font-size: 20px; font-weight: bold; color: #3498db;">0</div>
                        </div>
                        <div>
                            <span style="color: #7f8c8d; font-size: 12px;">Habitaciones Pagadas</span>
                            <div id="monthRoomsPaid" style="font-size: 20px; font-weight: bold; color: #9b59b6;">0</div>
                        </div>
                        <div>
                            <span style="color: #7f8c8d; font-size: 12px;">Habitaciones Pendientes</span>
                            <div id="monthRoomsPending" style="font-size: 20px; font-weight: bold; color: #e74c3c;">0</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Filtros adicionales -->
            <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center;">
                <input type="text" id="paymentSearchInput" placeholder="Buscar por habitaci√≥n o concepto..." 
                      style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 300px;"
                      onkeyup="filterPaymentsTable()">
                
                <select id="paymentTypeFilter" onchange="filterPaymentsTable()" 
                        style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="">Todos los conceptos</option>
                    <option value="Alquiler">Solo Alquiler</option>
                    <option value="Internet">Solo Internet</option>
                    <option value="Ambos">Alquiler + Internet</option>
                </select>
                
                <button class="export-button" onclick="exportMonthPayments()">Exportar Mes</button>
            </div>
            
            <!-- Indicador del mes mostrado -->
            <div id="currentViewingMonth" style="background: #3498db; color: white; padding: 10px; border-radius: 4px; margin-bottom: 10px; text-align: center; font-weight: bold;">
                <!-- Se actualizar√° din√°micamente -->
            </div>
            
            <table id="paymentsTable">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Habitaci√≥n</th>
                        <th>Inquilino</th>
                        <th>Concepto</th>
                        <th>Monto</th>
                        <th>M√©todo</th>
                        <th>Referencia</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- GASTOS -->
        <div id="expenses" class="tab-content">
            <h2>Control de Gastos</h2>
            
            <!-- BARRA DE NAVEGACI√ìN DE MESES PARA GASTOS -->
            <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px;">
                    
                    <!-- Controles de navegaci√≥n -->
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <button class="button button-small" onclick="navigateExpenseMonth(-1)">‚óÑ Mes Anterior</button>
                        
                        <select id="expenseMonthSelect" onchange="loadExpensesBySelectedMonth()" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="1">Enero</option>
                            <option value="2">Febrero</option>
                            <option value="3">Marzo</option>
                            <option value="4">Abril</option>
                            <option value="5">Mayo</option>
                            <option value="6">Junio</option>
                            <option value="7">Julio</option>
                            <option value="8">Agosto</option>
                            <option value="9">Septiembre</option>
                            <option value="10">Octubre</option>
                            <option value="11">Noviembre</option>
                            <option value="12">Diciembre</option>
                        </select>
                        
                        <select id="expenseYearSelect" onchange="loadExpensesBySelectedMonth()" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <!-- Se llenar√° din√°micamente -->
                        </select>
                        
                        <button class="button button-small" onclick="navigateExpenseMonth(1)">Mes Siguiente ‚ñ∫</button>
                    </div>
                    
                    <!-- Botones de acci√≥n -->
                    <div>
                        <button class="button" onclick="showNewExpenseModal()">Nuevo Gasto</button>
                        <button class="button button-success" onclick="goToCurrentExpenseMonth()">Mes Actual</button>
                    </div>
                </div>
                
                <!-- Resumen de gastos del mes -->
                <div id="expenseMonthSummary" style="margin-top: 15px; padding: 10px; background: white; border-radius: 4px; display: none;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div>
                            <span style="color: #7f8c8d; font-size: 12px;">Total Gastos del Mes</span>
                            <div id="monthTotalExpenses" style="font-size: 20px; font-weight: bold; color: #e74c3c;">S/ 0.00</div>
                        </div>
                        <div>
                            <span style="color: #7f8c8d; font-size: 12px;">Mantenimiento</span>
                            <div id="monthMaintenanceExpenses" style="font-size: 20px; font-weight: bold; color: #f39c12;">S/ 0.00</div>
                        </div>
                        <div>
                            <span style="color: #7f8c8d; font-size: 12px;">Servicios</span>
                            <div id="monthServicesExpenses" style="font-size: 20px; font-weight: bold; color: #3498db;">S/ 0.00</div>
                        </div>
                        <div>
                            <span style="color: #7f8c8d; font-size: 12px;">Otros Gastos</span>
                            <div id="monthOtherExpenses" style="font-size: 20px; font-weight: bold; color: #95a5a6;">S/ 0.00</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Filtros y b√∫squeda -->
            <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center;">
                <input type="text" id="expenseSearchInput" placeholder="Buscar gasto..." 
                      style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 300px;"
                      onkeyup="filterExpensesTable()">
                
                <select id="expenseCategoryFilter" onchange="filterExpensesTable()" 
                        style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="">Todas las categor√≠as</option>
                    <option value="Mantenimiento">Mantenimiento</option>
                    <option value="Servicios">Servicios</option>
                    <option value="Limpieza">Limpieza</option>
                    <option value="Reparaciones">Reparaciones</option>
                    <option value="Otros">Otros</option>
                </select>
                
                <button class="export-button" onclick="exportMonthExpenses()">Exportar Gastos</button>
            </div>
            
            <table id="expensesTable">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Concepto</th>
                        <th>Categor√≠a</th>
                        <th>Monto</th>
                        <th>√Årea/Habitaci√≥n</th>
                        <th>Observaciones</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- INCIDENCIAS -->
        <div id="incidents" class="tab-content">
            <h2>Gesti√≥n de Incidencias</h2>
            <button class="button" onclick="showNewIncidentModal()">Nueva Incidencia</button>
            
            <div class="filter-controls">
                <select id="incidentFilter">
                    <option value="">Todas las incidencias</option>
                    <option value="Pendiente">Pendientes</option>
                    <option value="Resuelto">Resueltas</option>
                </select>
                <select id="priorityFilter">
                    <option value="">Todas las prioridades</option>
                    <option value="Alta">Alta</option>
                    <option value="Media">Media</option>
                    <option value="Baja">Baja</option>
                </select>
            </div>

            <div id="incidentsList"></div>
        </div>

        <!-- REPORTES -->
        <div id="reports" class="tab-content">
            <h2>Reportes y An√°lisis</h2>
            <div class="button-group">
                <button class="button" onclick="generateReport()">Generar Reporte PDF</button>
                <button class="export-button" onclick="exportData('Habitaciones')">Exportar Habitaciones</button>
                <button class="export-button" onclick="exportData('Inquilinos')">Exportar Inquilinos</button>
                <button class="export-button" onclick="exportData('Pagos')">Exportar Pagos</button>
                <button class="export-button" onclick="exportData('Gastos')">Exportar Gastos</button>
            </div>
            <div id="reportsContent"></div>
        </div>

        <!-- VOUCHERS -->
        <div id="vouchers" class="tab-content">
            <h2>Gesti√≥n de Vouchers</h2>
            <div id="vouchersContent"></div>
        </div>

    </div>

    <!-- MODALES -->
    
    <!-- Modal de Habitaci√≥n -->
    <div id="roomModal" class="modal">
        <div class="modal-content">
            <h3>Editar Habitaci√≥n</h3>
            <form id="roomForm">
                <input type="hidden" id="roomId">
                <div class="form-group">
                    <label>Inquilino:</label>
                    <input type="text" id="roomTenant" required>
                </div>
                <div class="form-group">
                    <label>Celular:</label>
                    <input type="text" id="roomPhone">
                </div>
                <div class="form-group">
                    <label>Monto Alquiler (S/):</label>
                    <input type="number" id="roomRent" required>
                </div>
                <div class="form-group">
                    <label>Monto Internet (S/):</label>
                    <input type="number" id="roomInternet" required>
                </div>
                <div class="form-group">
                    <label>Estado:</label>
                    <select id="roomStatus">
                        <option value="vacant">Disponible</option>
                        <option value="occupied">Ocupado</option>
                    </select>
                </div>
                <button type="button" class="button" onclick="saveRoom()">Guardar</button>
                <button type="button" class="button button-danger" onclick="closeModal('roomModal')">Cancelar</button>
            </form>
        </div>
    </div>

    <!-- Modal de Inquilino -->
    <div id="tenantModal" class="modal">
        <div class="modal-content">
            <h3>Nuevo Inquilino</h3>
            <form id="tenantForm">
                <input type="hidden" id="tenantId">
                <div class="form-group">
                    <label>Nombre:</label>
                    <input type="text" id="tenantName" required>
                </div>
                <div class="form-group">
                    <label>DNI:</label>
                    <input type="text" id="tenantDni" maxlength="8" required>
                </div>
                <div class="form-group">
                    <label>Tel√©fono:</label>
                    <input type="text" id="tenantPhone" required>
                </div>
                <div class="form-group">
                    <label>Email:</label>
                    <input type="email" id="tenantEmail">
                </div>
                <div class="form-group">
                    <label>Habitaci√≥n:</label>
                    <select id="tenantRoom" required></select>
                </div>
                <button type="button" class="button" onclick="saveTenant()">Guardar</button>
                <button type="button" class="button button-danger" onclick="closeModal('tenantModal')">Cancelar</button>
            </form>
        </div>
    </div>


    <!-- AGREGAR AQU√ç EL MODAL DE NOTIFICACIONES -->
    <div id="notificationsModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>Notificaciones del Sistema</h3>
                <button onclick="closeModal('notificationsModal')" style="background: none; border: none; font-size: 24px; cursor: pointer;">√ó</button>
            </div>
            <div id="notificationsList" style="max-height: 400px; overflow-y: auto;">
                <!-- Se llenar√° din√°micamente -->
            </div>
            <div style="margin-top: 20px; text-align: right;">
                <button class="button button-small" onclick="markAllNotificationsRead()">Marcar todas como le√≠das</button>
                <button class="button button-danger button-small" onclick="clearAllNotifications()">Limpiar todas</button>
            </div>
        </div>
    </div>

   
    <script>
        // Variables globales
        let currentMonth = new Date().getMonth() + 1;
        let currentYear = new Date().getFullYear();
        let currentEditingTenantId = null;
        
        // Inicializaci√≥n
        // Inicializaci√≥n corregida
        window.onload = function() {
            // Establecer mes actual correctamente
            const now = new Date();
            currentMonth = now.getMonth() + 1;
            currentYear = now.getFullYear();
            
            // Actualizar selector de mes
            const monthSelect = document.getElementById('monthSelect');
            if (monthSelect) {
                monthSelect.value = currentMonth;
            }
            
            // Cargar configuraci√≥n y datos
            loadCurrentMonth();
            loadDashboard();
            loadAdvancedStats();
            showNotifications();
            
            // Inicializar modal de notificaciones
            initializeNotificationsModal();

            // AGREGAR: Inicializar selector de a√±os
            const yearSelect = document.getElementById('yearSelect');
            if (yearSelect) {
                const currentYear = new Date().getFullYear();
                yearSelect.innerHTML = '';
                for (let year = currentYear - 2; year <= currentYear + 1; year++) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    if (year === currentYear) {
                        option.selected = true;
                    }
                    yearSelect.appendChild(option);
                }
            }
        };
        
        // Cargar mes actual
        function loadCurrentMonth() {
            google.script.run
                .withSuccessHandler(function(result) {
                    currentMonth = result.month;
                    currentYear = result.year;
                    document.getElementById('monthSelect').value = currentMonth;
                    hideLoading();
                })
                .withFailureHandler(handleError)
                .getCurrentMonth();
        }
        
        // Cargar dashboard
        function loadDashboard() {
            showLoading();
            google.script.run
                .withSuccessHandler(function(data) {
                    document.getElementById('totalRooms').textContent = data.totalRooms;
                    document.getElementById('occupiedRooms').textContent = data.occupiedRooms;
                    document.getElementById('occupancyRate').textContent = data.occupancyRate + '%';
                    document.getElementById('monthlyIncome').textContent = 'S/ ' + data.totalIncome.toFixed(2);
                    document.getElementById('monthlyExpenses').textContent = 'S/ ' + data.totalExpenses.toFixed(2);
                    document.getElementById('balance').textContent = 'S/ ' + data.balance.toFixed(2);
                    hideLoading();
                })
                .withFailureHandler(handleError)
                .getMonthlyReport();
        }
        
        // Mostrar tab
        function showTab(tabName, event) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.sidebar li').forEach(item => {
                item.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            switch(tabName) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'rooms':
                    loadRooms();
                    break;
                case 'tenants':
                    loadTenants();
                    break;
                case 'payments':
                    loadPayments();
                    break;
                case 'expenses':
                    loadExpenses();
                    break;
                case 'incidents':
                    loadIncidents();
                    break;
                case 'vouchers':
                    loadVouchers();
                    break;
            }
        }
        
        // Cargar habitaciones
        // Cargar habitaciones con informaci√≥n de deudas
        function loadRooms() {
            showLoading();
            google.script.run
                .withSuccessHandler(function(rooms) {
                    const grid = document.getElementById('roomsGrid');
                    grid.innerHTML = '';
                    
                    if (!Array.isArray(rooms)) {
                        grid.innerHTML = '<p>Error al cargar habitaciones</p>';
                        hideLoading();
                        return;
                    }
                    
                    // Calcular estad√≠sticas
                    let totalPorCobrar = 0;
                    let habitacionesDeudoras = 0;
                    let habitacionesAlDia = 0;
                    let habitacionesVacias = 0;
                    const deudaDetails = [];
                    
                    // Obtener d√≠a actual
                    const today = new Date();
                    const currentDay = today.getDate();
                    const dueDay = 5; // D√≠a de vencimiento
                    const diasVencido = currentDay > dueDay ? currentDay - dueDay : 0;
                    
                    rooms.forEach(room => {
                        const card = document.createElement('div');
                        let cardClass = 'room-card';
                        let statusIndicator = '';
                        let debtAmount = 0;
                        
                        const roomId = room.id || room.iD || 'Sin ID';
                        const roomName = room.nombre || '';
                        const isOccupied = room.estado === 'occupied';
                        const alquilerPagado = room.alquilerpagado === true || room.alquilerpagado === 'TRUE' || room.alquilerpagado === 'true';
                        const internetPagado = room.internetpagado === true || room.internetpagado === 'TRUE' || room.internetpagado === 'true';
                        
                        if (isOccupied) {
                            // Calcular deuda
                            if (!alquilerPagado) {
                                debtAmount += parseFloat(room.montoalquiler || 0);
                            }
                            if (!internetPagado) {
                                debtAmount += parseFloat(room.montointernet || 0);
                            }
                            
                            if (debtAmount > 0) {
                                cardClass += ' room-debt';
                                statusIndicator = 'debt';
                                habitacionesDeudoras++;
                                totalPorCobrar += debtAmount;
                                
                                // Agregar a detalles de deuda
                                deudaDetails.push({
                                    id: roomId,
                                    nombre: roomName,
                                    celular: room.celular || '',
                                    alquiler: !alquilerPagado ? parseFloat(room.montoalquiler || 0) : 0,
                                    internet: !internetPagado ? parseFloat(room.montointernet || 0) : 0,
                                    total: debtAmount,
                                    diasVencido: diasVencido
                                });
                            } else {
                                cardClass += ' room-paid';
                                statusIndicator = 'paid';
                                habitacionesAlDia++;
                            }
                        } else {
                            cardClass += ' vacant';
                            statusIndicator = 'vacant';
                            habitacionesVacias++;
                        }
                        
                        card.className = cardClass;
                        card.onclick = () => showRoomModal(room);
                        
                        // Crear contenido de la tarjeta
                        let cardContent = `
                            <div style="position: relative;">
                                <h4 style="margin-bottom: 8px; color: #2c3e50;">${roomId}</h4>
                        `;
                        
                        // Agregar indicador de estado
                        if (statusIndicator === 'debt') {
                            cardContent += `
                                <div style="position: absolute; top: -5px; right: -5px; background: #e74c3c; color: white; 
                                            border-radius: 50%; width: 25px; height: 25px; display: flex; 
                                            align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">
                                    $
                                </div>
                            `;
                        } else if (statusIndicator === 'paid') {
                            cardContent += `
                                <div style="position: absolute; top: -5px; right: -5px; background: #27ae60; color: white; 
                                            border-radius: 50%; width: 25px; height: 25px; display: flex; 
                                            align-items: center; justify-content: center; font-size: 16px;">
                                    ‚úì
                                </div>
                            `;
                        }
                        
                        cardContent += `</div>`;
                        
                        if (isOccupied) {
                            cardContent += `
                                <p style="font-weight: bold; color: #34495e; margin: 5px 0;">${roomName || 'Sin nombre'}</p>
                                <p style="font-size: 12px; color: #7f8c8d; margin: 5px 0;">üì± ${room.celular || 'Sin tel√©fono'}</p>
                            `;
                            
                            // Mostrar estado de pagos
                            cardContent += `
                                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ecf0f1;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                        <span style="font-size: 12px;">Alquiler:</span>
                                        <span class="${alquilerPagado ? 'status-paid' : 'status-pending'}" style="font-size: 12px; font-weight: bold;">
                                            ${alquilerPagado ? '‚úì Pagado' : `S/ ${room.montoalquiler || 0}`}
                                        </span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="font-size: 12px;">Internet:</span>
                                        <span class="${internetPagado ? 'status-paid' : 'status-pending'}" style="font-size: 12px; font-weight: bold;">
                                            ${internetPagado ? '‚úì Pagado' : `S/ ${room.montointernet || 0}`}
                                        </span>
                                    </div>
                                </div>
                            `;
                            
                            if (debtAmount > 0) {
                                cardContent += `
                                    <div style="margin-top: 10px; padding: 8px; background: #fee; border-radius: 5px; text-align: center;">
                                        <strong style="color: #e74c3c;">Debe: S/ ${debtAmount.toFixed(2)}</strong>
                                        ${diasVencido > 0 ? `<br><small style="color: #c0392b;">Vencido hace ${diasVencido} d√≠as</small>` : ''}
                                    </div>
                                    <button class="button button-small" style="width: 100%; margin-top: 10px;" 
                                            onclick="event.stopPropagation(); quickPaymentFromRoom('${roomId}', ${debtAmount})">
                                        Registrar Pago
                                    </button>
                                `;
                            }
                        } else {
                            cardContent += `
                                <p style="color: #95a5a6; text-align: center; margin: 20px 0;">
                                    <strong>DISPONIBLE</strong>
                                </p>
                                <div style="text-align: center;">
                                    <p style="font-size: 12px; color: #7f8c8d;">Alquiler: S/ ${room.montoalquiler || 0}</p>
                                    <p style="font-size: 12px; color: #7f8c8d;">Internet: S/ ${room.montointernet || 0}</p>
                                </div>
                            `;
                        }
                        
                        card.innerHTML = cardContent;
                        grid.appendChild(card);
                    });
                    
                    // Actualizar resumen
                    document.getElementById('totalPorCobrar').textContent = `S/ ${totalPorCobrar.toFixed(2)}`;
                    document.getElementById('habitacionesDeudoras').textContent = habitacionesDeudoras;
                    document.getElementById('habitacionesAlDia').textContent = habitacionesAlDia;
                    
                    // Actualizar fecha de vencimiento
                    const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                                      'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                    document.getElementById('fechaVencimiento').textContent = 
                        `D√≠a ${dueDay} de ${monthNames[today.getMonth()]}`;
                    
                    // Actualizar tabla de deudas si hay deudas
                    if (deudaDetails.length > 0) {
                        updateDebtDetailsTable(deudaDetails);
                        document.getElementById('debtDetails').style.display = 'block';
                    } else {
                        document.getElementById('debtDetails').style.display = 'none';
                    }
                    
                    hideLoading();
                })
                .withFailureHandler(function(error) {
                    console.error('Error al cargar habitaciones:', error);
                    document.getElementById('roomsGrid').innerHTML = '<p>Error al cargar habitaciones</p>';
                    hideLoading();
                })
                .getAllRooms();
        }

        // Actualizar tabla de detalles de deuda
        function updateDebtDetailsTable(deudaDetails) {
            const tbody = document.getElementById('debtDetailsBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            deudaDetails.forEach(detail => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td style="padding: 10px;"><strong>${detail.id}</strong></td>
                    <td style="padding: 10px;">${detail.nombre}</td>
                    <td style="padding: 10px;">${detail.celular}</td>
                    <td style="padding: 10px; color: ${detail.alquiler > 0 ? '#e74c3c' : '#27ae60'};">
                        ${detail.alquiler > 0 ? `S/ ${detail.alquiler.toFixed(2)}` : '‚úì Pagado'}
                    </td>
                    <td style="padding: 10px; color: ${detail.internet > 0 ? '#e74c3c' : '#27ae60'};">
                        ${detail.internet > 0 ? `S/ ${detail.internet.toFixed(2)}` : '‚úì Pagado'}
                    </td>
                    <td style="padding: 10px; font-weight: bold; color: #e74c3c;">
                        S/ ${detail.total.toFixed(2)}
                    </td>
                    <td style="padding: 10px;">
                        ${detail.diasVencido > 0 ? `<span style="color: #e74c3c;">${detail.diasVencido} d√≠as</span>` : 'Al d√≠a'}
                    </td>
                    <td style="padding: 10px;">
                        <button class="button button-small" onclick="quickPaymentFromRoom('${detail.id}', ${detail.total})">
                            Cobrar
                        </button>
                    </td>
                `;
            });
        }

        // Filtrar habitaciones
        function filterRooms(filter) {
            const cards = document.querySelectorAll('.room-card');
            
            // Resetear botones
            document.querySelectorAll('[id^="filter"]').forEach(btn => {
                btn.style.opacity = '0.6';
            });
            
            // Activar bot√≥n seleccionado
            if (filter === 'all') {
                document.getElementById('filterAll').style.opacity = '1';
                cards.forEach(card => card.style.display = 'block');
            } else if (filter === 'debt') {
                document.getElementById('filterDebt').style.opacity = '1';
                cards.forEach(card => {
                    card.style.display = card.classList.contains('room-debt') ? 'block' : 'none';
                });
            } else if (filter === 'paid') {
                document.getElementById('filterPaid').style.opacity = '1';
                cards.forEach(card => {
                    card.style.display = card.classList.contains('room-paid') ? 'block' : 'none';
                });
            } else if (filter === 'vacant') {
                document.getElementById('filterVacant').style.opacity = '1';
                cards.forEach(card => {
                    card.style.display = card.classList.contains('vacant') ? 'block' : 'none';
                });
            }
        }

        // Buscar habitaciones
        function searchRooms() {
            const searchTerm = document.getElementById('roomSearchInput').value.toLowerCase();
            const cards = document.querySelectorAll('.room-card');
            
            cards.forEach(card => {
                const text = card.textContent.toLowerCase();
                card.style.display = text.includes(searchTerm) ? 'block' : 'none';
            });
        }

        // Pago r√°pido desde habitaci√≥n
        function quickPaymentFromRoom(roomId, amount) {
            showNewPaymentModal();
            
            setTimeout(() => {
                const roomSelect = document.getElementById('paymentRoom');
                if (roomSelect) {
                    for (let i = 0; i < roomSelect.options.length; i++) {
                        if (roomSelect.options[i].value === roomId) {
                            roomSelect.selectedIndex = i;
                            break;
                        }
                    }
                }
                
                document.getElementById('paymentAmount').value = amount;
                document.getElementById('paymentConcept').value = 'Ambos';
            }, 500);
        }
        
        // Cargar inquilinos con botones de acci√≥n
        function loadTenants() {
            showLoading();
            google.script.run
                .withSuccessHandler(function(tenants) {
                    const tbody = document.querySelector('#tenantsTable tbody');
                    if (!tbody) {
                        hideLoading();
                        return;
                    }
                    
                    tbody.innerHTML = '';
                    
                    if (!Array.isArray(tenants)) {
                        tbody.innerHTML = '<tr><td colspan="6">Error al cargar los datos</td></tr>';
                        hideLoading();
                        return;
                    }
                    
                    if (tenants.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6">No hay inquilinos registrados</td></tr>';
                        hideLoading();
                        return;
                    }
                    
                    tenants.forEach(tenant => {
                        const row = tbody.insertRow();
                        const tenantId = tenant.iD || tenant.id || '';
                        row.innerHTML = `
                            <td>${tenantId}</td>
                            <td>${tenant.nombre || ''} ${tenant.apellido || ''}</td>
                            <td>${tenant.habitacionAsignada || tenant.habitacionasignada || ''}</td>
                            <td>${tenant.telefono || ''}</td>
                            <td>${tenant.estadoActual || tenant.estadoactual || 'Activo'}</td>
                            <td>
                                <button class="button button-small" onclick="editTenant('${tenantId}')">Editar</button>
                                <button class="button button-danger button-small" onclick="deleteTenantConfirm('${tenantId}')">Eliminar</button>
                            </td>
                        `;
                    });
                    
                    hideLoading();
                })
                .withFailureHandler(handleError)
                .getAllTenants();
        }
        
        // Cargar pagos
        function loadPayments() {
            showLoading();
            google.script.run
                .withSuccessHandler(function(payments) {
                    const tbody = document.querySelector('#paymentsTable tbody');
                    tbody.innerHTML = '';
                    
                    if (!Array.isArray(payments) || payments.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5">No hay pagos registrados</td></tr>';
                        hideLoading();
                        return;
                    }
                    
                    payments.forEach(payment => {
                        const row = tbody.insertRow();
                        const fecha = new Date(payment.fecha).toLocaleDateString();
                        row.innerHTML = `
                            <td>${fecha}</td>
                            <td>${payment.habitacionId || payment.id}</td>
                            <td>${payment.tipoPago}</td>
                            <td>S/ ${payment.monto}</td>
                            <td>${payment.estado}</td>
                        `;
                    });
                    
                    hideLoading();
                })
                .withFailureHandler(handleError)
                .getPaymentsByMonth(currentYear, currentMonth);
        }
        
        // Cargar gastos
        function loadExpenses() {
            showLoading();
            google.script.run
                .withSuccessHandler(function(expenses) {
                    const tbody = document.querySelector('#expensesTable tbody');
                    tbody.innerHTML = '';
                    
                    if (!Array.isArray(expenses) || expenses.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="4">No hay gastos registrados</td></tr>';
                        hideLoading();
                        return;
                    }
                    
                    expenses.forEach(expense => {
                        const row = tbody.insertRow();
                        const fecha = new Date(expense.fecha).toLocaleDateString();
                        row.innerHTML = `
                            <td>${fecha}</td>
                            <td>${expense.concepto}</td>
                            <td>${expense.categoria}</td>
                            <td>S/ ${expense.monto}</td>
                        `;
                    });
                    
                    hideLoading();
                })
                .withFailureHandler(handleError)
                .getExpensesByMonth(currentYear, currentMonth);
        }
        
        // Mostrar modal de habitaci√≥n
        function showRoomModal(room) {
            document.getElementById('roomId').value = room.id;
            document.getElementById('roomTenant').value = room.nombre || '';
            document.getElementById('roomPhone').value = room.celular || '';
            document.getElementById('roomRent').value = room.montoalquiler || 0;
            document.getElementById('roomInternet').value = room.montointernet || 0;
            document.getElementById('roomStatus').value = room.estado || 'vacant';
            
            document.getElementById('roomModal').style.display = 'flex';
        }
        
        // Guardar habitaci√≥n
        function saveRoom() {
            const roomData = {
                id: document.getElementById('roomId').value,
                nombre: document.getElementById('roomTenant').value,
                celular: document.getElementById('roomPhone').value,
                montoAlquiler: parseFloat(document.getElementById('roomRent').value),
                montoInternet: parseFloat(document.getElementById('roomInternet').value),
                estado: document.getElementById('roomStatus').value,
                alquilerPagado: false,
                internetPagado: false,
                piso: '1',
                ubicacion: 'centro',
                observaciones: ''
            };
            
            showLoading();
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        closeModal('roomModal');
                        loadRooms();
                        showNotification('Habitaci√≥n actualizada exitosamente');
                    } else {
                        showNotification('Error: ' + result.message, 'error');
                    }
                    hideLoading();
                })
                .withFailureHandler(handleError)
                .updateRoomData(roomData);
        }
        
        // Mostrar modal de nuevo inquilino
        function showNewTenantModal() {
            currentEditingTenantId = null;
            document.querySelector('#tenantModal h3').textContent = 'Nuevo Inquilino';
            document.getElementById('tenantForm').reset();
            
            google.script.run
                .withSuccessHandler(function(rooms) {
                    const select = document.getElementById('tenantRoom');
                    select.innerHTML = '';
                    
                    rooms.filter(r => r.estado === 'vacant').forEach(room => {
                        const option = document.createElement('option');
                        option.value = room.id;
                        option.textContent = room.id;
                        select.appendChild(option);
                    });
                    
                    document.getElementById('tenantModal').style.display = 'flex';
                })
                .withFailureHandler(handleError)
                .getAllRooms();
        }
        
        // Editar inquilino
        function editTenant(tenantId) {
            showLoading();
            google.script.run
                .withSuccessHandler(function(tenant) {
                    if (tenant) {
                        currentEditingTenantId = tenantId;
                        document.querySelector('#tenantModal h3').textContent = 'Editar Inquilino';
                        
                        document.getElementById('tenantName').value = tenant.nombre;
                        document.getElementById('tenantDni').value = tenant.dni;
                        document.getElementById('tenantPhone').value = tenant.telefono;
                        document.getElementById('tenantEmail').value = tenant.email || '';
                        
                        google.script.run
                            .withSuccessHandler(function(rooms) {
                                const select = document.getElementById('tenantRoom');
                                select.innerHTML = '';
                                
                                const currentOption = document.createElement('option');
                                currentOption.value = tenant.habitacionAsignada;
                                currentOption.textContent = tenant.habitacionAsignada + ' (Actual)';
                                currentOption.selected = true;
                                select.appendChild(currentOption);
                                
                                rooms.filter(r => r.estado === 'vacant').forEach(room => {
                                    const option = document.createElement('option');
                                    option.value = room.id;
                                    option.textContent = room.id;
                                    select.appendChild(option);
                                });
                                
                                document.getElementById('tenantModal').style.display = 'flex';
                            })
                            .getAllRooms();
                    } else {
                        showNotification('Inquilino no encontrado', 'error');
                    }
                    hideLoading();
                })
                .withFailureHandler(handleError)
                .getTenantById(tenantId);
        }
        
        // Guardar inquilino (nuevo o editado)
        function saveTenant() {
            const tenantData = {
                nombre: document.getElementById('tenantName').value,
                dni: document.getElementById('tenantDni').value,
                telefono: document.getElementById('tenantPhone').value,
                email: document.getElementById('tenantEmail').value,
                habitacionAsignada: document.getElementById('tenantRoom').value,
                fechaIngreso: new Date().toISOString().split('T')[0]
            };
            
            showLoading();
            
            if (currentEditingTenantId) {
                tenantData.id = currentEditingTenantId;
                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result.success) {
                            closeModal('tenantModal');
                            loadTenants();
                            showNotification('Inquilino actualizado exitosamente');
                        } else {
                            showNotification('Error: ' + result.message, 'error');
                        }
                        hideLoading();
                    })
                    .withFailureHandler(handleError)
                    .updateTenant(tenantData);
            } else {
                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result.success) {
                            closeModal('tenantModal');
                            loadTenants();
                            showNotification('Inquilino registrado exitosamente');
                        } else {
                            showNotification('Error: ' + result.message, 'error');
                        }
                        hideLoading();
                    })
                    .withFailureHandler(handleError)
                    .addTenant(tenantData);
            }
        }
        
        // Eliminar inquilino
        function deleteTenantConfirm(tenantId) {
            if (confirm('¬øEst√° seguro de eliminar este inquilino? Esta acci√≥n no se puede deshacer.')) {
                showLoading();
                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result.success) {
                            loadTenants();
                            showNotification('Inquilino eliminado exitosamente');
                        } else {
                            showNotification('Error: ' + result.message, 'error');
                        }
                        hideLoading();
                    })
                    .withFailureHandler(handleError)
                    .deleteTenant(tenantId);
            }
        }
        
        // Resetear pagos mensuales
        function resetMonthlyPaymentsConfirm() {
            if (confirm('¬øEst√° seguro de reiniciar todos los pagos del mes? Esta acci√≥n marcar√° todos los pagos como pendientes.')) {
                showLoading();
                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result.success) {
                            loadDashboard();
                            loadRooms();
                            showNotification(result.message);
                        } else {
                            showNotification('Error: ' + result.message, 'error');
                        }
                        hideLoading();
                    })
                    .withFailureHandler(handleError)
                    .resetMonthlyPayments();
            }
        }
        
        // Ver historial de pagos
        function showPaymentHistory(roomId) {
            showLoading();
            google.script.run
                .withSuccessHandler(function(payments) {
                    displayPaymentHistory(roomId, payments);
                    hideLoading();
                })
                .withFailureHandler(handleError)
                .getPaymentHistory(roomId);
        }
        
        // Mostrar historial de pagos
        function displayPaymentHistory(roomId, payments) {
            const modal = document.createElement('div');
            modal.id = 'historyModal';
            modal.className = 'modal';
            
            let historyHTML = `
                <div class="modal-content">
                    <h3>Historial de Pagos - Habitaci√≥n ${roomId}</h3>
                    <div style="max-height: 400px; overflow-y: auto;">
            `;
            
            if (payments.length === 0) {
                historyHTML += '<p>No hay pagos registrados para esta habitaci√≥n</p>';
            } else {
                historyHTML += `
                    <table style="width: 100%;">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Concepto</th>
                                <th>Monto</th>
                                <th>M√©todo</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                payments.forEach(payment => {
                    const fecha = new Date(payment.fecha).toLocaleDateString();
                    historyHTML += `
                        <tr>
                            <td>${fecha}</td>
                            <td>${payment.tipoPago}</td>
                            <td>S/ ${payment.monto}</td>
                            <td>${payment.metodoPago}</td>
                            <td>${payment.estado}</td>
                        </tr>
                    `;
                });
                
                historyHTML += '</tbody></table>';
            }
            
            historyHTML += `
                    </div>
                    <button class="button button-danger" onclick="closeModal('historyModal')">Cerrar</button>
                </div>
            `;
            
            modal.innerHTML = historyHTML;
            modal.style.display = 'flex';
            document.body.appendChild(modal);
        }
        
        // Mostrar modal de nuevo pago
        function showNewPaymentModal() {
            const paymentModal = document.createElement('div');
            paymentModal.id = 'paymentModal';
            paymentModal.className = 'modal';
            paymentModal.innerHTML = `
                <div class="modal-content">
                    <h3>Registrar Nuevo Pago</h3>
                    <form id="paymentForm">
                        <div class="form-group">
                            <label>Habitaci√≥n:</label>
                            <select id="paymentRoom" required></select>
                        </div>
                        <div class="form-group">
                            <label>Concepto:</label>
                            <select id="paymentConcept">
                                <option value="Alquiler">Alquiler</option>
                                <option value="Internet">Internet</option>
                                <option value="Ambos">Alquiler + Internet</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Monto (S/):</label>
                            <input type="number" id="paymentAmount" required>
                        </div>
                        <div class="form-group">
                            <label>M√©todo de Pago:</label>
                            <select id="paymentMethod">
                                <option value="Efectivo">Efectivo</option>
                                <option value="Transferencia">Transferencia</option>
                                <option value="Yape">Yape</option>
                                <option value="Plin">Plin</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Voucher/Referencia:</label>
                            <input type="text" id="paymentVoucher">
                        </div>
                        <button type="button" class="button" onclick="savePayment()">Guardar</button>
                        <button type="button" class="button button-danger" onclick="closeModal('paymentModal')">Cancelar</button>
                    </form>
                </div>
            `;
            
            if (!document.getElementById('paymentModal')) {
                document.body.appendChild(paymentModal);
            }
            
            google.script.run
                .withSuccessHandler(function(rooms) {
                    const select = document.getElementById('paymentRoom');
                    select.innerHTML = '';
                    
                    rooms.filter(r => r.estado === 'occupied').forEach(room => {
                        const option = document.createElement('option');
                        option.value = room.id;
                        option.textContent = `${room.id} - ${room.nombre}`;
                        select.appendChild(option);
                    });
                    
                    document.getElementById('paymentModal').style.display = 'flex';
                })
                .withFailureHandler(handleError)
                .getAllRooms();
        }

        // Guardar pago
        function savePayment() {
            const paymentData = {
                habitacionId: document.getElementById('paymentRoom').value,
                concepto: document.getElementById('paymentConcept').value,
                monto: parseFloat(document.getElementById('paymentAmount').value),
                metodoPago: document.getElementById('paymentMethod').value,
                voucher: document.getElementById('paymentVoucher').value,
                fecha: new Date().toISOString().split('T')[0]
            };
            
            const roomSelect = document.getElementById('paymentRoom');
            const selectedOption = roomSelect.options[roomSelect.selectedIndex];
            paymentData.inquilino = selectedOption.textContent.split(' - ')[1];
            
            showLoading();
            
            const generateVoucher = confirm('¬øDesea generar un voucher PDF para este pago?');
            
            if (generateVoucher) {
                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result.success) {
                            closeModal('paymentModal');
                            loadPayments();
                            loadDashboard();
                            showNotification('Pago registrado exitosamente');
                            
                            if (result.voucherUrl) {
                                window.open(result.voucherUrl, '_blank');
                                showNotification('Voucher generado correctamente');
                            }
                        } else {
                            showNotification('Error: ' + result.message, 'error');
                        }
                        hideLoading();
                    })
                    .withFailureHandler(handleError)
                    .registerPaymentWithVoucher(paymentData);
            } else {
                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result.success) {
                            closeModal('paymentModal');
                            loadPayments();
                            loadDashboard();
                            showNotification('Pago registrado exitosamente');
                        } else {
                            showNotification('Error: ' + result.message, 'error');
                        }
                        hideLoading();
                    })
                    .withFailureHandler(handleError)
                    .registerPayment(paymentData);
            }
        }

        // Mostrar modal de nuevo gasto
        function showNewExpenseModal() {
            const expenseModal = document.createElement('div');
            expenseModal.id = 'expenseModal';
            expenseModal.className = 'modal';
            expenseModal.innerHTML = `
                <div class="modal-content">
                    <h3>Registrar Nuevo Gasto</h3>
                    <form id="expenseForm">
                        <div class="form-group">
                            <label>Concepto:</label>
                            <input type="text" id="expenseConcept" required>
                        </div>
                        <div class="form-group">
                            <label>Categor√≠a:</label>
                            <select id="expenseCategory">
                                <option value="Mantenimiento">Mantenimiento</option>
                                <option value="Servicios">Servicios</option>
                                <option value="Limpieza">Limpieza</option>
                                <option value="Reparaciones">Reparaciones</option>
                                <option value="Otros">Otros</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Monto (S/):</label>
                            <input type="number" id="expenseAmount" required>
                        </div>
                        <div class="form-group">
                            <label>Habitaci√≥n/√Årea:</label>
                            <input type="text" id="expenseArea">
                        </div>
                        <div class="form-group">
                            <label>Observaciones:</label>
                            <textarea id="expenseObservations" rows="4"></textarea>
                        </div>
                        <button type="button" class="button" onclick="saveExpense()">Guardar</button>
                        <button type="button" class="button button-danger" onclick="closeModal('expenseModal')">Cancelar</button>
                    </form>
                </div>
            `;
            
            if (!document.getElementById('expenseModal')) {
                document.body.appendChild(expenseModal);
            }
            
            document.getElementById('expenseModal').style.display = 'flex';
        }

        // Guardar gasto
        function saveExpense() {
            const expenseData = {
                concepto: document.getElementById('expenseConcept').value,
                categoria: document.getElementById('expenseCategory').value,
                monto: parseFloat(document.getElementById('expenseAmount').value),
                habitacionArea: document.getElementById('expenseArea').value,
                observaciones: document.getElementById('expenseObservations').value,
                fecha: new Date().toISOString().split('T')[0]
            };
            
            showLoading();
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        closeModal('expenseModal');
                        loadExpenses();
                        loadDashboard();
                        showNotification('Gasto registrado exitosamente');
                    } else {
                        showNotification('Error: ' + result.message, 'error');
                    }
                    hideLoading();
                })
                .withFailureHandler(handleError)
                .registerExpense(expenseData);
        }
        
        // Cargar vouchers
        function loadVouchers() {
            showLoading();
            google.script.run
                .withSuccessHandler(function(vouchers) {
                    displayVouchers(vouchers);
                    hideLoading();
                })
                .withFailureHandler(handleError)
                .getVouchers();
        }

        // Mostrar vouchers
        function displayVouchers(vouchers) {
            const container = document.getElementById('vouchersContent');
            if (!container) return;
            
            let html = '<div class="vouchers-grid">';
            
            if (vouchers.length === 0) {
                html += '<p>No hay vouchers generados</p>';
            } else {
                vouchers.forEach(voucher => {
                    const fecha = new Date(voucher.fecha).toLocaleDateString();
                    html += `
                        <div class="voucher-card">
                            <h4>Voucher ${voucher.id}</h4>
                            <p>Habitaci√≥n: ${voucher.habitacionID}</p>
                            <p>Fecha: ${fecha}</p>
                            <p>Monto: S/ ${voucher.monto}</p>
                            <a href="${voucher.url}" target="_blank" class="button button-small">Ver PDF</a>
                        </div>
                    `;
                });
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        // Cargar incidencias
        function loadIncidents() {
            showLoading();
            google.script.run
                .withSuccessHandler(function(incidents) {
                    displayIncidents(incidents);
                    hideLoading();
                })
                .withFailureHandler(handleError)
                .getIncidents();
        }

        // Mostrar incidencias
        function displayIncidents(incidents) {
            const container = document.getElementById('incidentsList');
            if (!container) return;
            
            let html = '<table class="incidents-table">';
            html += '<thead><tr>';
            html += '<th>Fecha</th><th>Habitaci√≥n</th><th>Tipo</th><th>Descripci√≥n</th><th>Prioridad</th><th>Estado</th><th>Acciones</th>';
            html += '</tr></thead><tbody>';
            
            incidents.forEach(incident => {
                const fecha = new Date(incident.fecha).toLocaleDateString();
                const priorityClass = incident.prioridad === 'Alta' ? 'priority-high' : 
                                    incident.prioridad === 'Media' ? 'priority-medium' : 'priority-low';
                const statusClass = incident.estado === 'Resuelto' ? 'status-resolved' : 'status-pending';
                
                html += `<tr>`;
                html += `<td>${fecha}</td>`;
                html += `<td>${incident.habitacionID}</td>`;
                html += `<td>${incident.tipoIncidencia}</td>`;
                html += `<td>${incident.descripcion}</td>`;
                html += `<td class="${priorityClass}">${incident.prioridad}</td>`;
                html += `<td class="${statusClass}">${incident.estado}</td>`;
                html += `<td><button onclick="resolveIncident('${incident.id}')">Resolver</button></td>`;
                html += `</tr>`;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Mostrar modal de nueva incidencia
        function showNewIncidentModal() {
            const modal = document.createElement('div');
            modal.id = 'incidentModal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <h3>Reportar Nueva Incidencia</h3>
                    <form id="incidentForm">
                        <div class="form-group">
                            <label>Habitaci√≥n:</label>
                            <select id="incidentRoom" required></select>
                        </div>
                        <div class="form-group">
                            <label>Tipo de Incidencia:</label>
                            <select id="incidentType">
                                <option value="Mantenimiento">Mantenimiento</option>
                                <option value="Limpieza">Limpieza</option>
                                <option value="Da√±o">Da√±o</option>
                                <option value="Queja">Queja</option>
                                <option value="Otro">Otro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Descripci√≥n:</label>
                            <textarea id="incidentDescription" required style="width: 100%; min-height: 100px;"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Prioridad:</label>
                            <select id="incidentPriority">
                                <option value="Baja">Baja</option>
                                <option value="Media">Media</option>
                                <option value="Alta">Alta</option>
                            </select>
                        </div>
                        <button type="button" class="button" onclick="saveIncident()">Guardar</button>
                        <button type="button" class="button button-danger" onclick="closeModal('incidentModal')">Cancelar</button>
                    </form>
                </div>
            `;
            
            if (!document.getElementById('incidentModal')) {
                document.body.appendChild(modal);
            }
            
            google.script.run
                .withSuccessHandler(function(rooms) {
                    const select = document.getElementById('incidentRoom');
                    select.innerHTML = '';
                    rooms.forEach(room => {
                        const option = document.createElement('option');
                        option.value = room.id;
                        option.textContent = `${room.id} - ${room.nombre || 'Vac√≠o'}`;
                        select.appendChild(option);
                    });
                })
                .getAllRooms();
            
            modal.style.display = 'flex';
        }

        // Guardar incidencia
        function saveIncident() {
            const incidentData = {
                habitacionID: document.getElementById('incidentRoom').value,
                tipoIncidencia: document.getElementById('incidentType').value,
                descripcion: document.getElementById('incidentDescription').value,
                prioridad: document.getElementById('incidentPriority').value
            };
            
            showLoading();
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        closeModal('incidentModal');
                        loadIncidents();
                        showNotification('Incidencia registrada con √©xito');
                    } else {
                        showNotification('Error: ' + result.message, 'error');
                    }
                    hideLoading();
                })
                .withFailureHandler(handleError)
                .registerIncident(incidentData);
        }

        // Resolver incidencia
        function resolveIncident(incidentId) {
            if (confirm('¬øEst√° seguro de marcar esta incidencia como resuelta?')) {
                showLoading();
                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result.success) {
                            loadIncidents();
                            showNotification('Incidencia resuelta exitosamente');
                        } else {
                            showNotification('Error: ' + result.message, 'error');
                        }
                        hideLoading();
                    })
                    .withFailureHandler(handleError)
                    .resolveIncident(incidentId);
            }
        }
        
        // Mostrar notificaciones
        function showNotifications() {
            google.script.run
                .withSuccessHandler(function(notifications) {
                    const notificationBadge = document.getElementById('notificationBadge');
                    if (notifications.length > 0) {
                        notificationBadge.textContent = notifications.length;
                        notificationBadge.style.display = 'inline';
                    } else {
                        notificationBadge.style.display = 'none';
                    }
                })
                .withFailureHandler(handleError)
                .getPendingNotifications();
        }

        // Buscar inquilinos
        function searchTenantsUI() {
            const query = document.getElementById('searchInput').value;
            if (query.length < 2) return;
            
            google.script.run
                .withSuccessHandler(function(results) {
                    displaySearchResults(results);
                })
                .withFailureHandler(handleError)
                .searchTenants(query);
        }

        // Mostrar estad√≠sticas avanzadas
        function loadAdvancedStats() {
            google.script.run
                .withSuccessHandler(function(stats) {
                    if (stats) {
                        displayAdvancedStats(stats);
                    }
                })
                .withFailureHandler(handleError)
                .getAdvancedStats();
        }

        // Mostrar estad√≠sticas avanzadas
        function displayAdvancedStats(stats) {
            const statsContainer = document.getElementById('advancedStats');
            if (!statsContainer) return;
            
            let html = '<div class="stats-advanced">';
            
            if (stats.overdueTenants && stats.overdueTenants.length > 0) {
                html += '<div class="stat-card warning">';
                html += '<h4>Inquilinos Morosos</h4>';
                html += '<ul>';
                stats.overdueTenants.forEach(tenant => {
                    html += `<li>${tenant.inquilino} - Hab. ${tenant.habitacion}: S/ ${tenant.montoAdeudado} (${tenant.diasVencido} d√≠as)</li>`;
                });
                html += '</ul>';
                html += '</div>';
            }
            
            if (stats.urgentIncidents > 0) {
                html += '<div class="stat-card danger">';
                html += '<h4>Incidencias Urgentes</h4>';
                html += `<div class="value">${stats.urgentIncidents}</div>`;
                html += '</div>';
            }
            
            if (stats.expensesByCategory) {
                html += '<div class="stat-card">';
                html += '<h4>Gastos por Categor√≠a</h4>';
                html += '<ul>';
                Object.entries(stats.expensesByCategory).forEach(([category, amount]) => {
                    html += `<li>${category}: S/ ${amount.toFixed(2)}</li>`;
                });
                html += '</ul>';
                html += '</div>';
            }
            
            html += '</div>';
            statsContainer.innerHTML = html;
        }

        // Generar reporte PDF
        function generateReport() {
            showLoading();
            google.script.run
                .withSuccessHandler(function(url) {
                    if (url) {
                        window.open(url, '_blank');
                        showNotification('Reporte generado exitosamente');
                    } else {
                        showNotification('Error al generar el reporte', 'error');
                    }
                    hideLoading();
                })
                .withFailureHandler(handleError)
                .generateMonthlyReportPDF();
        }

        // Exportar datos
        function exportData(sheetName) {
            google.script.run
                .withSuccessHandler(function(csv) {
                    if (csv) {
                        const blob = new Blob([csv], { type: 'text/csv' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `${sheetName}_${new Date().toISOString()}.csv`;
                        a.click();
                        URL.revokeObjectURL(url);
                        showNotification('Datos exportados exitosamente');
                    }
                })
                .withFailureHandler(handleError)
                .exportToCSV(sheetName);
        }

        // Crear backup
        function createBackup() {
            showLoading();
            google.script.run
                .withSuccessHandler(function(url) {
                    if (url) {
                        showNotification('Backup creado exitosamente');
                        window.open(url, '_blank');
                    } else {
                        showNotification('Error al crear el backup', 'error');
                    }
                    hideLoading();
                })
                .withFailureHandler(handleError)
                .createBackup();
        }
        
        // Cerrar modal
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
                if (modalId === 'historyModal') {
                    modal.remove();
                }
            }
        }
        
        // Mostrar/ocultar loading
        function showLoading() {
            document.getElementById('loading').style.display = 'flex';
        }
        
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }
        
        // Manejo de errores
        function handleError(error) {
            console.error('Error:', error);
            showNotification(`Error: ${error.message || error}`, 'error');
            hideLoading();
        }
        
        // Mostrar notificaci√≥n temporal
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 10);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // Actualizar mes
        function updateMonth() {
            currentMonth = parseInt(document.getElementById('monthSelect').value);
            showTab('dashboard');
        }
        
        // Funci√≥n debounce para b√∫squeda
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        // Variables para control de navegaci√≥n de pagos
        let paymentViewMonth = new Date().getMonth() + 1;
        let paymentViewYear = new Date().getFullYear();

        // Inicializar selectores de a√±o cuando se carga la p√°gina
        function initializePaymentYearSelector() {
            const yearSelect = document.getElementById('paymentYearSelect');
            if (!yearSelect) return;
            
            const currentYear = new Date().getFullYear();
            yearSelect.innerHTML = '';
            
            // Agregar √∫ltimos 3 a√±os y el actual
            for (let year = currentYear - 2; year <= currentYear + 1; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) {
                    option.selected = true;
                }
                yearSelect.appendChild(option);
            }
        }

        // Navegar entre meses
        function navigatePaymentMonth(direction) {
            paymentViewMonth += direction;
            
            if (paymentViewMonth > 12) {
                paymentViewMonth = 1;
                paymentViewYear++;
            } else if (paymentViewMonth < 1) {
                paymentViewMonth = 12;
                paymentViewYear--;
            }
            
            document.getElementById('paymentMonthSelect').value = paymentViewMonth;
            document.getElementById('paymentYearSelect').value = paymentViewYear;
            
            loadPaymentsBySelectedMonth();
        }

        // Ir al mes actual
        function goToCurrentMonth() {
            const now = new Date();
            paymentViewMonth = now.getMonth() + 1;
            paymentViewYear = now.getFullYear();
            
            document.getElementById('paymentMonthSelect').value = paymentViewMonth;
            document.getElementById('paymentYearSelect').value = paymentViewYear;
            
            loadPaymentsBySelectedMonth();
        }

        // Cargar pagos del mes seleccionado
        function loadPaymentsBySelectedMonth() {
            const monthSelect = document.getElementById('paymentMonthSelect');
            const yearSelect = document.getElementById('paymentYearSelect');
            
            if (!monthSelect || !yearSelect) return;
            
            paymentViewMonth = parseInt(monthSelect.value);
            paymentViewYear = parseInt(yearSelect.value);
            
            // Actualizar indicador del mes
            updateMonthIndicator();
            
            // Mostrar loading
            showLoading();
            
            // Cargar pagos del mes seleccionado
            google.script.run
                .withSuccessHandler(function(payments) {
                    displayPaymentsTable(payments);
                    updatePaymentSummary(payments);
                    hideLoading();
                })
                .withFailureHandler(handleError)
                .getPaymentsByMonth(paymentViewYear, paymentViewMonth);
        }

        // Actualizar indicador del mes mostrado
        function updateMonthIndicator() {
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                              'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            
            const indicator = document.getElementById('currentViewingMonth');
            if (indicator) {
                indicator.textContent = `Mostrando pagos de ${monthNames[paymentViewMonth - 1]} ${paymentViewYear}`;
            }
        }

        // Mostrar tabla de pagos mejorada
        function displayPaymentsTable(payments) {
            const tbody = document.querySelector('#paymentsTable tbody');
            tbody.innerHTML = '';
            
            if (!Array.isArray(payments) || payments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">No hay pagos registrados en este mes</td></tr>';
                return;
            }
            
            // Ordenar pagos por fecha descendente
            payments.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            
            payments.forEach(payment => {
                const row = tbody.insertRow();
                const fecha = new Date(payment.fecha);
                const fechaFormateada = fecha.toLocaleDateString('es-PE', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric'
                });
                
                // Obtener nombre del inquilino si est√° disponible
                const inquilino = payment.inquilino || obtenerNombreInquilino(payment.habitacionId);
                
                row.innerHTML = `
                    <td>${fechaFormateada}</td>
                    <td><strong>${payment.habitacionId || ''}</strong></td>
                    <td>${inquilino || '-'}</td>
                    <td>${payment.tipoPago || payment.concepto || ''}</td>
                    <td style="color: #27ae60; font-weight: bold;">S/ ${parseFloat(payment.monto || 0).toFixed(2)}</td>
                    <td>${payment.metodoPago || '-'}</td>
                    <td>${payment.referencia || payment.voucher || '-'}</td>
                    <td><span style="background: #27ae60; color: white; padding: 2px 8px; border-radius: 3px; font-size: 12px;">${payment.estado || 'Pagado'}</span></td>
                `;
            });
        }

        // Actualizar resumen del mes
        function updatePaymentSummary(payments) {
            const summaryDiv = document.getElementById('paymentMonthSummary');
            if (!summaryDiv) return;
            
            summaryDiv.style.display = 'block';
            
            // Calcular totales
            const totalCollected = payments.reduce((sum, p) => sum + parseFloat(p.monto || 0), 0);
            const paymentCount = payments.length;
            
            // Obtener habitaciones √∫nicas que pagaron
            const paidRooms = new Set(payments.map(p => p.habitacionId)).size;
            
            // Actualizar valores en el DOM
            document.getElementById('monthTotalCollected').textContent = `S/ ${totalCollected.toFixed(2)}`;
            document.getElementById('monthPaymentCount').textContent = paymentCount;
            document.getElementById('monthRoomsPaid').textContent = paidRooms;
            
            // Calcular habitaciones pendientes (requiere informaci√≥n adicional)
            google.script.run
                .withSuccessHandler(function(rooms) {
                    const occupiedRooms = rooms.filter(r => r.estado === 'occupied').length;
                    const pendingRooms = Math.max(0, occupiedRooms - paidRooms);
                    document.getElementById('monthRoomsPending').textContent = pendingRooms;
                })
                .withFailureHandler(function(error) {
                    document.getElementById('monthRoomsPending').textContent = '-';
                })
                .getAllRooms();
        }

        // Filtrar tabla de pagos
        function filterPaymentsTable() {
            const searchInput = document.getElementById('paymentSearchInput').value.toLowerCase();
            const typeFilter = document.getElementById('paymentTypeFilter').value.toLowerCase();
            const rows = document.querySelectorAll('#paymentsTable tbody tr');
            
            rows.forEach(row => {
                const cells = row.getElementsByTagName('td');
                if (cells.length === 1) return; // Skip "no data" row
                
                const habitacion = cells[1].textContent.toLowerCase();
                const inquilino = cells[2].textContent.toLowerCase();
                const concepto = cells[3].textContent.toLowerCase();
                
                const matchesSearch = !searchInput || 
                                    habitacion.includes(searchInput) || 
                                    inquilino.includes(searchInput) ||
                                    concepto.includes(searchInput);
                
                const matchesType = !typeFilter || concepto.includes(typeFilter);
                
                row.style.display = matchesSearch && matchesType ? '' : 'none';
            });
        }

        // Exportar pagos del mes
        function exportMonthPayments() {
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                              'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            
            showLoading();
            google.script.run
                .withSuccessHandler(function(payments) {
                    if (!payments || payments.length === 0) {
                        showNotification('No hay pagos para exportar en este mes', 'warning');
                        hideLoading();
                        return;
                    }
                    
                    // Crear CSV
                    let csv = 'Fecha,Habitaci√≥n,Inquilino,Concepto,Monto,M√©todo,Referencia,Estado\n';
                    
                    payments.forEach(payment => {
                        const fecha = new Date(payment.fecha).toLocaleDateString('es-PE');
                        csv += `"${fecha}","${payment.habitacionId}","${payment.inquilino || '-'}","${payment.tipoPago}","S/ ${payment.monto}","${payment.metodoPago}","${payment.referencia || '-'}","${payment.estado}"\n`;
                    });
                    
                    // Descargar archivo
                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `Pagos_${monthNames[paymentViewMonth - 1]}_${paymentViewYear}.csv`;
                    link.click();
                    URL.revokeObjectURL(url);
                    
                    showNotification('Pagos exportados exitosamente');
                    hideLoading();
                })
                .withFailureHandler(handleError)
                .getPaymentsByMonth(paymentViewYear, paymentViewMonth);
        }

        // Funci√≥n auxiliar para obtener nombre del inquilino
        function obtenerNombreInquilino(habitacionId) {
            // Esta funci√≥n puede ser mejorada para buscar en cache local
            return '';
        }

        // MODIFICAR la funci√≥n loadPayments existente
        function loadPayments() {
            // Inicializar selector de a√±o si no est√° inicializado
            initializePaymentYearSelector();
            
            // Establecer mes y a√±o actuales
            const now = new Date();
            paymentViewMonth = now.getMonth() + 1;
            paymentViewYear = now.getFullYear();
            
            document.getElementById('paymentMonthSelect').value = paymentViewMonth;
            document.getElementById('paymentYearSelect').value = paymentViewYear;
            
            // Cargar pagos del mes actual
            loadPaymentsBySelectedMonth();
        }
        // ============ FUNCIONES PARA CONTROL DE GASTOS ============

        // Variables para control de gastos
        let expenseViewMonth = new Date().getMonth() + 1;
        let expenseViewYear = new Date().getFullYear();
        let currentEditingExpenseId = null;

        // Inicializar selector de a√±o para gastos
        function initializeExpenseYearSelector() {
            const yearSelect = document.getElementById('expenseYearSelect');
            if (!yearSelect) return;
            
            const currentYear = new Date().getFullYear();
            yearSelect.innerHTML = '';
            
            for (let year = currentYear - 2; year <= currentYear + 1; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) {
                    option.selected = true;
                }
                yearSelect.appendChild(option);
            }
        }

        // Navegar entre meses de gastos
        function navigateExpenseMonth(direction) {
            expenseViewMonth += direction;
            
            if (expenseViewMonth > 12) {
                expenseViewMonth = 1;
                expenseViewYear++;
            } else if (expenseViewMonth < 1) {
                expenseViewMonth = 12;
                expenseViewYear--;
            }
            
            document.getElementById('expenseMonthSelect').value = expenseViewMonth;
            document.getElementById('expenseYearSelect').value = expenseViewYear;
            
            loadExpensesBySelectedMonth();
        }

        // Ir al mes actual de gastos
        function goToCurrentExpenseMonth() {
            const now = new Date();
            expenseViewMonth = now.getMonth() + 1;
            expenseViewYear = now.getFullYear();
            
            document.getElementById('expenseMonthSelect').value = expenseViewMonth;
            document.getElementById('expenseYearSelect').value = expenseViewYear;
            
            loadExpensesBySelectedMonth();
        }

        // Cargar gastos del mes seleccionado
        function loadExpensesBySelectedMonth() {
            const monthSelect = document.getElementById('expenseMonthSelect');
            const yearSelect = document.getElementById('expenseYearSelect');
            
            if (!monthSelect || !yearSelect) return;
            
            expenseViewMonth = parseInt(monthSelect.value);
            expenseViewYear = parseInt(yearSelect.value);
            
            showLoading();
            
            google.script.run
                .withSuccessHandler(function(expenses) {
                    displayExpensesTable(expenses);
                    updateExpenseSummary(expenses);
                    hideLoading();
                })
                .withFailureHandler(handleError)
                .getExpensesByMonth(expenseViewYear, expenseViewMonth);
        }

        // Mostrar tabla de gastos con botones de edici√≥n
        function displayExpensesTable(expenses) {
            const tbody = document.querySelector('#expensesTable tbody');
            tbody.innerHTML = '';
            
            if (!Array.isArray(expenses) || expenses.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No hay gastos registrados en este mes</td></tr>';
                return;
            }
            
            expenses.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            
            expenses.forEach(expense => {
                const row = tbody.insertRow();
                const fecha = new Date(expense.fecha).toLocaleDateString('es-PE');
                
                row.innerHTML = `
                    <td>${fecha}</td>
                    <td>${expense.concepto}</td>
                    <td><span class="category-badge" style="background: ${getCategoryColor(expense.categoria)}; color: white; padding: 3px 8px; border-radius: 3px; font-size: 12px;">${expense.categoria}</span></td>
                    <td style="color: #e74c3c; font-weight: bold;">S/ ${parseFloat(expense.monto || 0).toFixed(2)}</td>
                    <td>${expense.habitacionAsociada || '-'}</td>
                    <td>${expense.observaciones || '-'}</td>
                    <td>
                        <button class="button button-small" onclick="editExpense('${expense.id}')">Editar</button>
                        <button class="button button-danger button-small" onclick="deleteExpenseConfirm('${expense.id}')">Eliminar</button>
                    </td>
                `;
            });
        }

        // Obtener color por categor√≠a
        function getCategoryColor(category) {
            const colors = {
                'Mantenimiento': '#f39c12',
                'Servicios': '#3498db',
                'Limpieza': '#27ae60',
                'Reparaciones': '#e74c3c',
                'Otros': '#95a5a6'
            };
            return colors[category] || '#95a5a6';
        }

        // Actualizar resumen de gastos
        function updateExpenseSummary(expenses) {
            const summaryDiv = document.getElementById('expenseMonthSummary');
            if (!summaryDiv) return;
            
            summaryDiv.style.display = 'block';
            
            // Calcular totales por categor√≠a
            const totals = {
                total: 0,
                mantenimiento: 0,
                servicios: 0,
                otros: 0
            };
            
            expenses.forEach(expense => {
                const amount = parseFloat(expense.monto || 0);
                totals.total += amount;
                
                switch(expense.categoria) {
                    case 'Mantenimiento':
                        totals.mantenimiento += amount;
                        break;
                    case 'Servicios':
                        totals.servicios += amount;
                        break;
                    default:
                        totals.otros += amount;
                }
            });
            
            document.getElementById('monthTotalExpenses').textContent = `S/ ${totals.total.toFixed(2)}`;
            document.getElementById('monthMaintenanceExpenses').textContent = `S/ ${totals.mantenimiento.toFixed(2)}`;
            document.getElementById('monthServicesExpenses').textContent = `S/ ${totals.servicios.toFixed(2)}`;
            document.getElementById('monthOtherExpenses').textContent = `S/ ${totals.otros.toFixed(2)}`;
        }

        // Editar gasto
        function editExpense(expenseId) {
            showLoading();
            google.script.run
                .withSuccessHandler(function(expense) {
                    if (expense) {
                        showEditExpenseModal(expense);
                    } else {
                        showNotification('Gasto no encontrado', 'error');
                    }
                    hideLoading();
                })
                .withFailureHandler(handleError)
                .getExpenseById(expenseId);
        }

        // Mostrar modal de edici√≥n de gasto
        function showEditExpenseModal(expense) {
            currentEditingExpenseId = expense.id;
            
            document.getElementById('expenseConcept').value = expense.concepto;
            document.getElementById('expenseCategory').value = expense.categoria;
            document.getElementById('expenseAmount').value = expense.monto;
            document.getElementById('expenseArea').value = expense.habitacionAsociada || '';
            document.getElementById('expenseObservations').value = expense.observaciones || '';
            
            // Cambiar t√≠tulo del modal
            const modal = document.getElementById('expenseModal');
            if (modal) {
                modal.querySelector('h3').textContent = 'Editar Gasto';
            }
            
            document.getElementById('expenseModal').style.display = 'flex';
        }

        // Modificar funci√≥n saveExpense para soportar edici√≥n
        function saveExpense() {
            const expenseData = {
                concepto: document.getElementById('expenseConcept').value,
                categoria: document.getElementById('expenseCategory').value,
                monto: parseFloat(document.getElementById('expenseAmount').value),
                habitacionArea: document.getElementById('expenseArea').value,
                observaciones: document.getElementById('expenseObservations').value,
                fecha: new Date().toISOString().split('T')[0]
            };
            
            showLoading();
            
            if (currentEditingExpenseId) {
                expenseData.id = currentEditingExpenseId;
                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result.success) {
                            closeModal('expenseModal');
                            loadExpensesBySelectedMonth();
                            showNotification('Gasto actualizado exitosamente');
                            currentEditingExpenseId = null;
                        } else {
                            showNotification('Error: ' + result.message, 'error');
                        }
                        hideLoading();
                    })
                    .withFailureHandler(handleError)
                    .updateExpense(expenseData);
            } else {
                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result.success) {
                            closeModal('expenseModal');
                            loadExpensesBySelectedMonth();
                            showNotification('Gasto registrado exitosamente');
                        } else {
                            showNotification('Error: ' + result.message, 'error');
                        }
                        hideLoading();
                    })
                    .withFailureHandler(handleError)
                    .registerExpense(expenseData);
            }
        }

        // Eliminar gasto
        function deleteExpenseConfirm(expenseId) {
            if (confirm('¬øEst√° seguro de eliminar este gasto? Esta acci√≥n no se puede deshacer.')) {
                showLoading();
                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result.success) {
                            loadExpensesBySelectedMonth();
                            showNotification('Gasto eliminado exitosamente');
                        } else {
                            showNotification('Error: ' + result.message, 'error');
                        }
                        hideLoading();
                    })
                    .withFailureHandler(handleError)
                    .deleteExpense(expenseId);
            }
        }

        // Filtrar tabla de gastos
        function filterExpensesTable() {
            const searchInput = document.getElementById('expenseSearchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('expenseCategoryFilter').value;
            const rows = document.querySelectorAll('#expensesTable tbody tr');
            
            rows.forEach(row => {
                const cells = row.getElementsByTagName('td');
                if (cells.length === 1) return;
                
                const concepto = cells[1].textContent.toLowerCase();
                const categoria = cells[2].textContent;
                
                const matchesSearch = !searchInput || concepto.includes(searchInput);
                const matchesCategory = !categoryFilter || categoria.includes(categoryFilter);
                
                row.style.display = matchesSearch && matchesCategory ? '' : 'none';
            });
        }

        // Exportar gastos del mes
        function exportMonthExpenses() {
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                              'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            
            showLoading();
            google.script.run
                .withSuccessHandler(function(expenses) {
                    if (!expenses || expenses.length === 0) {
                        showNotification('No hay gastos para exportar', 'warning');
                        hideLoading();
                        return;
                    }
                    
                    let csv = 'Fecha,Concepto,Categor√≠a,Monto,√Årea,Observaciones\n';
                    
                    expenses.forEach(expense => {
                        const fecha = new Date(expense.fecha).toLocaleDateString('es-PE');
                        csv += `"${fecha}","${expense.concepto}","${expense.categoria}","S/ ${expense.monto}","${expense.habitacionAsociada || '-'}","${expense.observaciones || '-'}"\n`;
                    });
                    
                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `Gastos_${monthNames[expenseViewMonth - 1]}_${expenseViewYear}.csv`;
                    link.click();
                    URL.revokeObjectURL(url);
                    
                    showNotification('Gastos exportados exitosamente');
                    hideLoading();
                })
                .withFailureHandler(handleError)
                .getExpensesByMonth(expenseViewYear, expenseViewMonth);
        }

        // Modificar funci√≥n loadExpenses
        function loadExpenses() {
            initializeExpenseYearSelector();
            
            const now = new Date();
            expenseViewMonth = now.getMonth() + 1;
            expenseViewYear = now.getFullYear();
            
            document.getElementById('expenseMonthSelect').value = expenseViewMonth;
            document.getElementById('expenseYearSelect').value = expenseViewYear;
            
            loadExpensesBySelectedMonth();
        }

        // ============ FUNCIONES PARA DASHBOARD MEJORADO ============

        // Actualizar dashboard con m√°s informaci√≥n
        function loadDashboard() {
            showLoading();
            
            // Cargar estad√≠sticas principales
            google.script.run
                .withSuccessHandler(function(data) {
                    updateMainStats(data);
                    updateIndicators(data);
                    hideLoading();
                })
                .withFailureHandler(handleError)
                .getMonthlyReport();
            
            // Cargar pagos recientes
            loadRecentPayments();
            
            // Cargar pr√≥ximos vencimientos
            loadUpcomingDues();
            
            // Cargar alertas
            loadDashboardAlerts();
            
            // Cargar gr√°fico de tendencias
            loadTrendChart();
        }

        // Actualizar estad√≠sticas principales
        function updateMainStats(data) {
            document.getElementById('totalRooms').textContent = data.totalRooms;
            document.getElementById('occupiedRooms').textContent = data.occupiedRooms;
            document.getElementById('occupancyRate').textContent = data.occupancyRate + '%';
            document.getElementById('monthlyIncome').textContent = 'S/ ' + data.totalIncome.toFixed(2);
            document.getElementById('monthlyExpenses').textContent = 'S/ ' + data.totalExpenses.toFixed(2);
            document.getElementById('balance').textContent = 'S/ ' + data.balance.toFixed(2);
            
            // Actualizar porcentaje de ocupaci√≥n
            const occupancyPercentage = document.getElementById('occupancyPercentage');
            if (occupancyPercentage) {
                occupancyPercentage.textContent = `${data.occupiedRooms} de ${data.totalRooms}`;
            }
        }

        // Actualizar indicadores visuales
        function updateIndicators(data) {
            // Indicador de ocupaci√≥n
            const occupancyIndicator = document.getElementById('occupancyIndicator');
            if (occupancyIndicator) {
                const rate = parseFloat(data.occupancyRate);
                if (rate >= 80) {
                    occupancyIndicator.innerHTML = '<span style="color: #27ae60;">‚ñ≤ Excelente</span>';
                } else if (rate >= 60) {
                    occupancyIndicator.innerHTML = '<span style="color: #f39c12;">‚óè Normal</span>';
                } else {
                    occupancyIndicator.innerHTML = '<span style="color: #e74c3c;">‚ñº Bajo</span>';
                }
            }
            
            // Indicador de balance
            const balanceIndicator = document.getElementById('balanceIndicator');
            if (balanceIndicator) {
                if (data.balance > 0) {
                    balanceIndicator.innerHTML = '<span style="color: #27ae60;">‚ñ≤ Positivo</span>';
                } else if (data.balance === 0) {
                    balanceIndicator.innerHTML = '<span style="color: #f39c12;">‚óè Equilibrado</span>';
                } else {
                    balanceIndicator.innerHTML = '<span style="color: #e74c3c;">‚ñº Negativo</span>';
                }
            }
        }

        // Cargar pagos recientes
        function loadRecentPayments() {
            google.script.run
                .withSuccessHandler(function(payments) {
                    const container = document.getElementById('recentPaymentsList');
                    if (!container) return;
                    
                    if (!payments || payments.length === 0) {
                        container.innerHTML = '<p style="color: #95a5a6;">No hay pagos recientes</p>';
                        return;
                    }
                    
                    let html = '<ul style="list-style: none; padding: 0;">';
                    payments.slice(0, 5).forEach(payment => {
                        const fecha = new Date(payment.fecha).toLocaleDateString('es-PE');
                        html += `
                            <li style="padding: 10px; border-bottom: 1px solid #ecf0f1;">
                                <div style="display: flex; justify-content: space-between;">
                                    <div>
                                        <strong>${payment.habitacionId}</strong> - ${payment.tipoPago || payment.concepto}
                                        <br><small style="color: #95a5a6;">${fecha}</small>
                                    </div>
                                    <div style="color: #27ae60; font-weight: bold;">
                                        S/ ${parseFloat(payment.monto).toFixed(2)}
                                    </div>
                                </div>
                            </li>
                        `;
                    });
                    html += '</ul>';
                    
                    container.innerHTML = html;
                })
                .withFailureHandler(function(error) {
                    console.error('Error cargando pagos recientes:', error);
                })
                .getPaymentsByMonth(new Date().getFullYear(), new Date().getMonth() + 1);
        }

        // Cargar pr√≥ximos vencimientos - VERSI√ìN CORREGIDA
        function loadUpcomingDues() {
            google.script.run
                .withSuccessHandler(function(rooms) {
                    const container = document.getElementById('upcomingDuesList');
                    if (!container) return;
                    
                    // Filtrar habitaciones ocupadas con pagos pendientes
                    const unpaidRooms = rooms.filter(r => {
                        // Verificar si est√° ocupada
                        if (r.estado !== 'occupied') return false;
                        
                        // Verificar estado de pago (considerando diferentes formatos)
                        const alquilerPendiente = r.alquilerpagado === false || 
                                                r.alquilerpagado === 'false' || 
                                                r.alquilerpagado === 'FALSE' ||
                                                r.alquilerpagado === '' ||
                                                r.alquilerpagado === null;
                        
                        const internetPendiente = r.internetpagado === false || 
                                                r.internetpagado === 'false' || 
                                                r.internetpagado === 'FALSE' ||
                                                r.internetpagado === '' ||
                                                r.internetpagado === null;
                        
                        return alquilerPendiente || internetPendiente;
                    });
                    
                    if (unpaidRooms.length === 0) {
                        container.innerHTML = '<p style="color: #27ae60;">‚úì Todos los pagos est√°n al d√≠a</p>';
                        return;
                    }
                    
                    // Calcular d√≠a actual para determinar si est√° vencido
                    const today = new Date();
                    const currentDay = today.getDate();
                    const dueDay = 5; // D√≠a de vencimiento
                    
                    let html = '<ul style="list-style: none; padding: 0; margin: 0;">';
                    
                    unpaidRooms.forEach(room => {
                        let deudaTotal = 0;
                        let conceptosPendientes = [];
                        
                        // Verificar alquiler
                        const alquilerPendiente = room.alquilerpagado === false || 
                                                room.alquilerpagado === 'false' || 
                                                room.alquilerpagado === 'FALSE' ||
                                                room.alquilerpagado === '' ||
                                                room.alquilerpagado === null;
                        
                        if (alquilerPendiente) {
                            deudaTotal += parseFloat(room.montoalquiler || 0);
                            conceptosPendientes.push('Alquiler');
                        }
                        
                        // Verificar internet
                        const internetPendiente = room.internetpagado === false || 
                                                room.internetpagado === 'false' || 
                                                room.internetpagado === 'FALSE' ||
                                                room.internetpagado === '' ||
                                                room.internetpagado === null;
                        
                        if (internetPendiente) {
                            deudaTotal += parseFloat(room.montointernet || 0);
                            conceptosPendientes.push('Internet');
                        }
                        
                        // Determinar estado
                        const isVencido = currentDay > dueDay;
                        const diasVencido = isVencido ? currentDay - dueDay : 0;
                        const statusColor = isVencido ? '#e74c3c' : '#f39c12';
                        const statusText = isVencido ? `Vencido hace ${diasVencido} d√≠as` : `Vence el d√≠a ${dueDay}`;
                        
                        html += `
                            <li style="padding: 12px; border-bottom: 1px solid #ecf0f1; cursor: pointer;" 
                                onclick="showPaymentHistory('${room.id}')">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div style="flex: 1;">
                                        <strong style="color: #2c3e50; font-size: 14px;">
                                            Hab. ${room.id || room.iD}
                                        </strong>
                                        <span style="color: #7f8c8d; font-size: 12px;">
                                            - ${room.nombre || 'Sin inquilino'}
                                        </span>
                                        <br>
                                        <small style="color: ${statusColor}; font-weight: bold;">
                                            ${statusText}
                                        </small>
                                        <br>
                                        <small style="color: #95a5a6;">
                                            Pendiente: ${conceptosPendientes.join(' + ')}
                                        </small>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="color: ${statusColor}; font-weight: bold; font-size: 16px;">
                                            S/ ${deudaTotal.toFixed(2)}
                                        </div>
                                        <button class="button button-small" style="margin-top: 5px; padding: 3px 8px; font-size: 11px;"
                                                onclick="event.stopPropagation(); quickPayment('${room.id}', ${deudaTotal})">
                                            Registrar Pago
                                        </button>
                                    </div>
                                </div>
                            </li>
                        `;
                    });
                    
                    html += '</ul>';
                    
                    // Agregar resumen al final
                    const totalDeuda = unpaidRooms.reduce((sum, room) => {
                        let deuda = 0;
                        if (room.alquilerpagado === false || room.alquilerpagado === 'false' || room.alquilerpagado === 'FALSE') {
                            deuda += parseFloat(room.montoalquiler || 0);
                        }
                        if (room.internetpagado === false || room.internetpagado === 'false' || room.internetpagado === 'FALSE') {
                            deuda += parseFloat(room.montointernet || 0);
                        }
                        return sum + deuda;
                    }, 0);
                    
                    html += `
                        <div style="padding: 10px; background: #f8f9fa; margin-top: 10px; border-radius: 5px;">
                            <strong>Total Pendiente: </strong>
                            <span style="color: #e74c3c; font-size: 18px; font-weight: bold;">
                                S/ ${totalDeuda.toFixed(2)}
                            </span>
                            <br>
                            <small style="color: #7f8c8d;">
                                ${unpaidRooms.length} habitaci√≥n(es) con pagos pendientes
                            </small>
                        </div>
                    `;
                    
                    container.innerHTML = html;
                })
                .withFailureHandler(function(error) {
                    console.error('Error cargando vencimientos:', error);
                    const container = document.getElementById('upcomingDuesList');
                    if (container) {
                        container.innerHTML = '<p style="color: #95a5a6;">Error al cargar vencimientos</p>';
                    }
                })
                .getAllRooms();
        }

        // Funci√≥n para pago r√°pido desde vencimientos
        function quickPayment(roomId, amount) {
            // Pre-llenar el modal de pago con los datos
            showNewPaymentModal();
            
            // Esperar a que el modal se cargue
            setTimeout(() => {
                const roomSelect = document.getElementById('paymentRoom');
                if (roomSelect) {
                    // Seleccionar la habitaci√≥n
                    for (let i = 0; i < roomSelect.options.length; i++) {
                        if (roomSelect.options[i].value === roomId) {
                            roomSelect.selectedIndex = i;
                            break;
                        }
                    }
                }
                
                // Establecer el monto
                const amountInput = document.getElementById('paymentAmount');
                if (amountInput) {
                    amountInput.value = amount;
                }
                
                // Establecer concepto como "Ambos" si es el total
                const conceptSelect = document.getElementById('paymentConcept');
                if (conceptSelect) {
                    conceptSelect.value = 'Ambos';
                }
            }, 500);
        }

        // Cargar alertas del dashboard
        function loadDashboardAlerts() {
            const alertsContainer = document.getElementById('dashboardAlerts');
            if (!alertsContainer) return;
            
            google.script.run
                .withSuccessHandler(function(stats) {
                    if (!stats) return;
                    
                    let alerts = [];
                    
                    // Alerta de morosidad
                    if (stats.overdueTenants && stats.overdueTenants.length > 0) {
                        alerts.push({
                            type: 'warning',
                            message: `Hay ${stats.overdueTenants.length} inquilinos con pagos pendientes`,
                            icon: '‚ö†Ô∏è'
                        });
                    }
                    
                    // Alerta de incidencias
                    if (stats.urgentIncidents > 0) {
                        alerts.push({
                            type: 'danger',
                            message: `${stats.urgentIncidents} incidencias urgentes requieren atenci√≥n`,
                            icon: 'üö®'
                        });
                    }
                    
                    if (alerts.length === 0) {
                        alertsContainer.innerHTML = '';
                        return;
                    }
                    
                    let html = '<div style="margin-top: 20px;">';
                    alerts.forEach(alert => {
                        const bgColor = alert.type === 'danger' ? '#f8d7da' : '#fff3cd';
                        const borderColor = alert.type === 'danger' ? '#f5c6cb' : '#ffeeba';
                        
                        html += `
                            <div style="padding: 15px; margin-bottom: 10px; background: ${bgColor}; border-left: 4px solid ${borderColor}; border-radius: 4px;">
                                <strong>${alert.icon} ${alert.message}</strong>
                            </div>
                        `;
                    });
                    html += '</div>';
                    
                    alertsContainer.innerHTML = html;
                })
                .getAdvancedStats();
        }

        // Cargar gr√°fico de tendencias simple
        // Cargar gr√°fico de tendencias con datos reales
        function loadTrendChart() {
            showLoading();
            
            google.script.run
                .withSuccessHandler(function(trendData) {
                    if (!trendData || trendData.length === 0) {
                        console.log('No hay datos de tendencia disponibles');
                        hideLoading();
                        return;
                    }
                    
                    const canvas = document.getElementById('dashboardChart');
                    if (!canvas) {
                        hideLoading();
                        return;
                    }
                    
                    const ctx = canvas.getContext('2d');
                    
                    // Limpiar canvas
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    
                    // Configuraci√≥n del gr√°fico
                    const padding = 40;
                    const chartWidth = canvas.width - (padding * 2);
                    const chartHeight = canvas.height - (padding * 2);
                    const barWidth = chartWidth / (trendData.length * 3);
                    
                    // Encontrar valor m√°ximo para escala
                    let maxValue = 0;
                    trendData.forEach(data => {
                        maxValue = Math.max(maxValue, data.income, data.expenses);
                    });
                    
                    // Agregar 10% de margen superior
                    maxValue = maxValue * 1.1 || 1000;
                    
                    const scale = chartHeight / maxValue;
                    
                    // Nombres de meses
                    const monthNames = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 
                                      'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                    
                    // Dibujar ejes
                    ctx.beginPath();
                    ctx.moveTo(padding, padding);
                    ctx.lineTo(padding, canvas.height - padding);
                    ctx.lineTo(canvas.width - padding, canvas.height - padding);
                    ctx.strokeStyle = '#ddd';
                    ctx.stroke();
                    
                    // Dibujar l√≠neas de grid horizontales
                    ctx.strokeStyle = '#f0f0f0';
                    ctx.setLineDash([5, 5]);
                    for (let i = 0; i <= 5; i++) {
                        const y = padding + (chartHeight / 5 * i);
                        ctx.beginPath();
                        ctx.moveTo(padding, y);
                        ctx.lineTo(canvas.width - padding, y);
                        ctx.stroke();
                        
                        // Etiquetas del eje Y
                        ctx.fillStyle = '#7f8c8d';
                        ctx.font = '10px Arial';
                        ctx.textAlign = 'right';
                        const value = maxValue - (maxValue / 5 * i);
                        ctx.fillText(`S/ ${value.toFixed(0)}`, padding - 5, y + 3);
                    }
                    ctx.setLineDash([]);
                    
                    // Dibujar barras
                    trendData.forEach((data, index) => {
                        const x = padding + (index * chartWidth / trendData.length) + 20;
                        const baseY = canvas.height - padding;
                        
                        // Barra de ingresos (verde)
                        if (data.income > 0) {
                            const incomeHeight = data.income * scale;
                            ctx.fillStyle = '#27ae60';
                            ctx.fillRect(x, baseY - incomeHeight, barWidth, incomeHeight);
                            
                            // Valor encima de la barra
                            ctx.fillStyle = '#27ae60';
                            ctx.font = '9px Arial';
                            ctx.textAlign = 'center';
                            ctx.fillText(`${data.income.toFixed(0)}`, x + barWidth/2, baseY - incomeHeight - 5);
                        }
                        
                        // Barra de gastos (rojo)
                        if (data.expenses > 0) {
                            const expenseHeight = data.expenses * scale;
                            ctx.fillStyle = '#e74c3c';
                            ctx.fillRect(x + barWidth + 5, baseY - expenseHeight, barWidth, expenseHeight);
                            
                            // Valor encima de la barra
                            ctx.fillStyle = '#e74c3c';
                            ctx.font = '9px Arial';
                            ctx.textAlign = 'center';
                            ctx.fillText(`${data.expenses.toFixed(0)}`, x + barWidth + 5 + barWidth/2, baseY - expenseHeight - 5);
                        }
                        
                        // Etiqueta del mes
                        ctx.fillStyle = '#2c3e50';
                        ctx.font = '11px Arial';
                        ctx.textAlign = 'center';
                        const monthLabel = `${monthNames[data.month - 1]}`;
                        ctx.fillText(monthLabel, x + barWidth, baseY + 15);
                    });
                    
                    // Leyenda
                    const legendX = canvas.width - 120;
                    
                    // Leyenda de ingresos
                    ctx.fillStyle = '#27ae60';
                    ctx.fillRect(legendX, 20, 15, 15);
                    ctx.fillStyle = '#2c3e50';
                    ctx.font = '12px Arial';
                    ctx.textAlign = 'left';
                    ctx.fillText('Ingresos', legendX + 20, 32);
                    
                    // Leyenda de gastos
                    ctx.fillStyle = '#e74c3c';
                    ctx.fillRect(legendX, 45, 15, 15);
                    ctx.fillStyle = '#2c3e50';
                    ctx.fillText('Gastos', legendX + 20, 57);
                    
                    // T√≠tulo del gr√°fico
                    ctx.fillStyle = '#2c3e50';
                    ctx.font = 'bold 14px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('An√°lisis Financiero - √öltimos 6 Meses', canvas.width / 2, 20);
                    
                    hideLoading();
                })
                .withFailureHandler(function(error) {
                    console.error('Error cargando gr√°fico de tendencias:', error);
                    hideLoading();
                    
                    // Mostrar mensaje de error en el canvas
                    const canvas = document.getElementById('dashboardChart');
                    if (canvas) {
                        const ctx = canvas.getContext('2d');
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.fillStyle = '#95a5a6';
                        ctx.font = '14px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText('No hay datos suficientes para mostrar el gr√°fico', canvas.width / 2, canvas.height / 2);
                    }
                })
                .getTrendData();
        }

        // Actualizar dashboard
        function refreshDashboard() {
            loadDashboard();
            loadAdvancedStats();
            showNotification('Dashboard actualizado');
        }

        // Generar informe mensual
        function generateMonthlyReport() {
            showLoading();
            google.script.run
                .withSuccessHandler(function(url) {
                    if (url) {
                        window.open(url, '_blank');
                        showNotification('Informe generado exitosamente');
                    } else {
                        showNotification('Error al generar el informe', 'error');
                    }
                    hideLoading();
                })
                .withFailureHandler(handleError)
                .generateMonthlyReportPDF();
        }

        // Modal de pago r√°pido
        function showQuickPaymentModal() {
            showNewPaymentModal();
        }        
        // Inicializar funciones adicionales
        document.addEventListener('DOMContentLoaded', function() {
            setInterval(showNotifications, 30000);
            loadAdvancedStats();
            
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('keyup', debounce(searchTenantsUI, 300));
            }
        });
        // Inicializar modal de notificaciones
        function initializeNotificationsModal() {
            // Hacer clickeable el badge de notificaciones
            const notificationBadge = document.getElementById('notificationBadge');
            if (notificationBadge) {
                notificationBadge.style.cursor = 'pointer';
                notificationBadge.parentElement.style.cursor = 'pointer';
                notificationBadge.parentElement.onclick = showNotificationsModal;
            }
        }

        // Mostrar modal de notificaciones
        function showNotificationsModal() {
            google.script.run
                .withSuccessHandler(function(notifications) {
                    const list = document.getElementById('notificationsList');
                    if (!list) return;
                    
                    if (!notifications || notifications.length === 0) {
                        list.innerHTML = '<p style="text-align: center; color: #95a5a6;">No hay notificaciones pendientes</p>';
                    } else {
                        let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
                        
                        notifications.forEach(notif => {
                            const fecha = new Date(notif.fecha).toLocaleString('es-PE');
                            const iconMap = {
                                'Nueva incidencia': '‚ö†Ô∏è',
                                'Pago registrado': 'üí∞',
                                'Sistema': 'üîî',
                                'Recordatorio': 'üìÖ',
                                'Alerta': 'üö®'
                            };
                            const icon = iconMap[notif.tipo] || 'üì¢';
                            
                            html += `
                                <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; border-left: 3px solid #3498db;">
                                    <div style="display: flex; justify-content: space-between; align-items: start;">
                                        <div style="flex: 1;">
                                            <div style="font-weight: bold; color: #2c3e50; margin-bottom: 5px;">
                                                ${icon} ${notif.tipo}
                                            </div>
                                            <div style="color: #34495e; font-size: 14px;">
                                                ${notif.mensaje}
                                            </div>
                                            <div style="color: #95a5a6; font-size: 12px; margin-top: 5px;">
                                                ${fecha}
                                            </div>
                                        </div>
                                        <button onclick="dismissNotification('${notif.id}')" 
                                                style="background: none; border: none; color: #95a5a6; cursor: pointer; font-size: 18px;">
                                            √ó
                                        </button>
                                    </div>
                                </div>
                            `;
                        });
                        
                        html += '</div>';
                        list.innerHTML = html;
                    }
                    
                    document.getElementById('notificationsModal').style.display = 'flex';
                })
                .withFailureHandler(handleError)
                .getPendingNotifications();
        }

        // Descartar notificaci√≥n individual
        function dismissNotification(notificationId) {
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        showNotificationsModal(); // Recargar modal
                        showNotifications(); // Actualizar badge
                    }
                })
                .markNotificationAsRead(notificationId);
        }

        // Marcar todas como le√≠das
        function markAllNotificationsRead() {
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        closeModal('notificationsModal');
                        showNotifications();
                        showNotification('Todas las notificaciones marcadas como le√≠das');
                    }
                })
                .markAllNotificationsAsRead();
        }

        // Limpiar todas las notificaciones
        function clearAllNotifications() {
            if (confirm('¬øEst√° seguro de eliminar todas las notificaciones?')) {
                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result.success) {
                            closeModal('notificationsModal');
                            showNotifications();
                            showNotification('Notificaciones eliminadas');
                        }
                    })
                    .clearAllNotifications();
            }
        }        
        // Agregar al final de las funciones JavaScript en panel.html

        // Actualizar dashboard autom√°ticamente cada 2 minutos
        setInterval(function() {
            if (document.querySelector('.tab-content.active').id === 'dashboard') {
                loadUpcomingDues();
                loadRecentPayments();
            }
        }, 120000);

        // Funci√≥n para verificar y actualizar estados de pago
        function verifyPaymentStatus() {
            google.script.run
                .withSuccessHandler(function(summary) {
                    console.log('Estado de pagos actualizado:', summary);
                    
                    // Actualizar indicador en el header si existe
                    const header = document.querySelector('.header');
                    if (header && summary.roomsWithDebt > 0) {
                        // Crear o actualizar badge de deuda
                        let debtBadge = document.getElementById('debtBadge');
                        if (!debtBadge) {
                            debtBadge = document.createElement('span');
                            debtBadge.id = 'debtBadge';
                            debtBadge.style.cssText = 'background: #e74c3c; color: white; padding: 5px 10px; border-radius: 15px; font-size: 12px; margin-left: 20px;';
                            header.querySelector('h1').appendChild(debtBadge);
                        }
                        debtBadge.textContent = `${summary.roomsWithDebt} habitaciones con deuda - Total: S/ ${summary.totalDue.toFixed(2)}`;
                    }
                })
                .getDuePaymentsSummary();
        }

        // Ejecutar verificaci√≥n al cargar
        document.addEventListener('DOMContentLoaded', function() {
            verifyPaymentStatus();
        });
    </script>
</body>
</html>